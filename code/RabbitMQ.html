<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://hecan1020.github.io/code/RabbitMQ.html"><meta property="og:site_name" content="白米粥"><meta property="og:title" content="RabbitMQ学习笔记"><meta property="og:description" content="相关网站 尚硅谷RabbitMQ学习视频 (https://www.bilibili.com/video/BV1cb4y1o7zz/) RabbitMQ官网 (https://www.rabbitmq.com/) RabbitMQ安装DOC (https://www.rabbitmq.com/download.html) RabbitMQ-崔二旦 (h..."><meta property="og:type" content="article"><meta property="og:image" content="https://hecan1020.github.io/"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-04-12T13:51:31.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="RabbitMQ学习笔记"><meta property="article:author" content="白米粥"><meta property="article:modified_time" content="2023-04-12T13:51:31.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"RabbitMQ学习笔记","image":["https://hecan1020.github.io/"],"dateModified":"2023-04-12T13:51:31.000Z","author":[{"@type":"Person","name":"白米粥"}]}</script><title>RabbitMQ学习笔记 | 白米粥</title><meta name="description" content="相关网站 尚硅谷RabbitMQ学习视频 (https://www.bilibili.com/video/BV1cb4y1o7zz/) RabbitMQ官网 (https://www.rabbitmq.com/) RabbitMQ安装DOC (https://www.rabbitmq.com/download.html) RabbitMQ-崔二旦 (h...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-e269f769.css" as="style"><link rel="stylesheet" href="/assets/style-e269f769.css">
    <link rel="modulepreload" href="/assets/app-8bdbcd56.js"><link rel="modulepreload" href="/assets/framework-a4c02b8f.js"><link rel="modulepreload" href="/assets/RabbitMQ.html-0ef6683d.js"><link rel="modulepreload" href="/assets/RabbitMQ.html-88f9ca3b.js"><link rel="prefetch" href="/assets/index.html-91e3b1cd.js" as="script"><link rel="prefetch" href="/assets/Docker.html-df325cf5.js" as="script"><link rel="prefetch" href="/assets/Nginx.html-6052cc34.js" as="script"><link rel="prefetch" href="/assets/Shiro.html-c2c7d6d8.js" as="script"><link rel="prefetch" href="/assets/interview.html-55055590.js" as="script"><link rel="prefetch" href="/assets/interview_Q_A.html-01faf588.js" as="script"><link rel="prefetch" href="/assets/404.html-aae006ea.js" as="script"><link rel="prefetch" href="/assets/index.html-64b62ac0.js" as="script"><link rel="prefetch" href="/assets/index.html-f956062a.js" as="script"><link rel="prefetch" href="/assets/index.html-1bc2c36b.js" as="script"><link rel="prefetch" href="/assets/index.html-0f3ceb1e.js" as="script"><link rel="prefetch" href="/assets/index.html-87c6de97.js" as="script"><link rel="prefetch" href="/assets/index.html-abd265e0.js" as="script"><link rel="prefetch" href="/assets/index.html-285c5c05.js" as="script"><link rel="prefetch" href="/assets/index.html-4a72959f.js" as="script"><link rel="prefetch" href="/assets/index.html-694403e8.js" as="script"><link rel="prefetch" href="/assets/index.html-bcf0191c.js" as="script"><link rel="prefetch" href="/assets/index.html-155aa863.js" as="script"><link rel="prefetch" href="/assets/index.html-8522d90e.js" as="script"><link rel="prefetch" href="/assets/index.html-3ea68222.js" as="script"><link rel="prefetch" href="/assets/index.html-545f055e.js" as="script"><link rel="prefetch" href="/assets/Docker.html-604563df.js" as="script"><link rel="prefetch" href="/assets/Nginx.html-16780ebf.js" as="script"><link rel="prefetch" href="/assets/Shiro.html-87e88c4c.js" as="script"><link rel="prefetch" href="/assets/interview.html-a49038a5.js" as="script"><link rel="prefetch" href="/assets/interview_Q_A.html-57470f02.js" as="script"><link rel="prefetch" href="/assets/404.html-be487d22.js" as="script"><link rel="prefetch" href="/assets/index.html-82473335.js" as="script"><link rel="prefetch" href="/assets/index.html-738fa7ec.js" as="script"><link rel="prefetch" href="/assets/index.html-3e429ac3.js" as="script"><link rel="prefetch" href="/assets/index.html-8a5d7176.js" as="script"><link rel="prefetch" href="/assets/index.html-b1228c12.js" as="script"><link rel="prefetch" href="/assets/index.html-25bdd0f4.js" as="script"><link rel="prefetch" href="/assets/index.html-d18abf5a.js" as="script"><link rel="prefetch" href="/assets/index.html-e821ca32.js" as="script"><link rel="prefetch" href="/assets/index.html-6d5adef1.js" as="script"><link rel="prefetch" href="/assets/index.html-e53e1162.js" as="script"><link rel="prefetch" href="/assets/index.html-1e528248.js" as="script"><link rel="prefetch" href="/assets/index.html-25dddc9e.js" as="script"><link rel="prefetch" href="/assets/index.html-05297341.js" as="script"><link rel="prefetch" href="/assets/giscus-16d370b8.js" as="script"><link rel="prefetch" href="/assets/auto-ba5ecab5.js" as="script"><link rel="prefetch" href="/assets/index-b03bef79.js" as="script"><link rel="prefetch" href="/assets/flowchart-35969cab.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-55d3196b.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-a794bb63.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-d92a2fc9.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-224f94d9.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-e5069ce0.js" as="script"><link rel="prefetch" href="/assets/search.esm-2c3fba7d.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-b90f2e0c.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-6e6cbe40.js" as="script"><link rel="prefetch" href="/assets/SearchResult-68156931.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><!----><!----><span class="site-name">白米粥</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="主页"><span class="font-icon icon iconfont icon-home" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/article/" class="nav-link" aria-label="文章"><!---->文章<!----></a></div><div class="nav-item hide-in-mobile"><a href="/note/" class="nav-link" aria-label="随笔"><span class="font-icon icon iconfont icon-note" style=""></span>随笔<!----></a></div><div class="nav-item hide-in-mobile"><a href="/code/" class="nav-link active" aria-label="学习"><span class="font-icon icon iconfont icon-study" style=""></span>学习<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/hecan1020" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="placeholder">搜索</div><div class="key-hints"><kbd class="key">Ctrl</kbd><kbd class="key">K</kbd></div></button><!--]--><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><p class="sidebar-heading active"><span class="font-icon icon iconfont icon-study" style=""></span><span class="title">学习</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/code/Docker.html" class="nav-link sidebar-link sidebar-page" aria-label="Docker学习笔记"><!---->Docker学习笔记<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/code/Nginx.html" class="nav-link sidebar-link sidebar-page" aria-label="Nginx学习笔记"><!---->Nginx学习笔记<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/code/RabbitMQ.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="RabbitMQ学习笔记"><!---->RabbitMQ学习笔记<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#相关网站" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="相关网站"><!---->相关网站<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#使用mq的好处" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="使用MQ的好处"><!---->使用MQ的好处<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#mq的分类" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="MQ的分类"><!---->MQ的分类<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#四大核心概念" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="四大核心概念"><!---->四大核心概念<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#rabbitmq-模型架构" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="RabbitMQ 模型架构"><!---->RabbitMQ 模型架构<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#安装" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="安装"><!---->安装<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#rabbitmq工作模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="RabbitMQ工作模式"><!---->RabbitMQ工作模式<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#helloworld-简单队列模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="HelloWorld - 简单队列模式"><!---->HelloWorld - 简单队列模式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#work-queues-工作队列模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Work Queues - 工作队列模式"><!---->Work Queues - 工作队列模式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#消息应答" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="消息应答"><!---->消息应答<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#rabbitmq持久化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="RabbitMQ持久化"><!---->RabbitMQ持久化<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#发布确认-防止发送时消息丢失" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="发布确认(防止发送时消息丢失)"><!---->发布确认(防止发送时消息丢失)<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#交换机-发布-订阅模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="交换机 - 发布/订阅模式"><!---->交换机 - 发布/订阅模式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#死信队列" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="死信队列"><!---->死信队列<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#概念-5" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="概念"><!---->概念<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#来源" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="来源"><!---->来源<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#死信实战" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="死信实战"><!---->死信实战<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#延迟队列" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="延迟队列"><!---->延迟队列<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#概念-6" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="概念"><!---->概念<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#延迟队列使用场景" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="延迟队列使用场景"><!---->延迟队列使用场景<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#rabbitmq-中的-ttl" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="RabbitMQ 中的 TTL"><!---->RabbitMQ 中的 TTL<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#springboot-整合-rabbitmq" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="SpringBoot 整合 RabbitMQ"><!---->SpringBoot 整合 RabbitMQ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#发布确认高级" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="发布确认高级"><!---->发布确认高级<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#存在的问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="存在的问题"><!---->存在的问题<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#发布确认springboot版本" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="发布确认SpringBoot版本"><!---->发布确认SpringBoot版本<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#备份交换机" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="备份交换机"><!---->备份交换机<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#其它知识点" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="其它知识点"><!---->其它知识点<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#幂等性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="幂等性"><!---->幂等性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#优先级队列" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="优先级队列"><!---->优先级队列<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#惰性队列" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="惰性队列"><!---->惰性队列<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#rabbitmq集群" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="RabbitMQ集群"><!---->RabbitMQ集群<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#集群形式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="集群形式"><!---->集群形式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#haproxy-keepalived实现高可用的负载均衡" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="HAPROXY+KEEPALIVED实现高可用的负载均衡"><!---->HAPROXY+KEEPALIVED实现高可用的负载均衡<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#federation-exchange-联邦交换机" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Federation Exchange(联邦交换机)"><!---->Federation Exchange(联邦交换机)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#federation-queue-联邦队列" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Federation Queue(联邦队列)"><!---->Federation Queue(联邦队列)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/code/RabbitMQ.html#shovel" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Shovel"><!---->Shovel<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/code/Shiro.html" class="nav-link sidebar-link sidebar-page" aria-label="Shiro学习笔记"><!---->Shiro学习笔记<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->RabbitMQ学习笔记</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">白米粥</span></span><span property="author" content="白米粥"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-04-11T11:30:43.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 64 分钟</span><meta property="timeRequired" content="PT64M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category4 clickable" role="navigation">Java</span><span class="page-category-item category0 clickable" role="navigation">RabbitMQ</span><meta property="articleSection" content="Java,RabbitMQ"></span><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#相关网站" class="router-link-active router-link-exact-active toc-link level2">相关网站</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#使用mq的好处" class="router-link-active router-link-exact-active toc-link level2">使用MQ的好处</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#mq的分类" class="router-link-active router-link-exact-active toc-link level2">MQ的分类</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#四大核心概念" class="router-link-active router-link-exact-active toc-link level2">四大核心概念</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#rabbitmq-模型架构" class="router-link-active router-link-exact-active toc-link level2">RabbitMQ 模型架构</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#安装" class="router-link-active router-link-exact-active toc-link level2">安装</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#rabbitmq工作模式" class="router-link-active router-link-exact-active toc-link level2">RabbitMQ工作模式</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#helloworld-简单队列模式" class="router-link-active router-link-exact-active toc-link level3">HelloWorld - 简单队列模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#work-queues-工作队列模式" class="router-link-active router-link-exact-active toc-link level3">Work Queues - 工作队列模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#消息应答" class="router-link-active router-link-exact-active toc-link level3">消息应答</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#rabbitmq持久化" class="router-link-active router-link-exact-active toc-link level3">RabbitMQ持久化</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#发布确认-防止发送时消息丢失" class="router-link-active router-link-exact-active toc-link level3">发布确认(防止发送时消息丢失)</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#交换机-发布-订阅模式" class="router-link-active router-link-exact-active toc-link level2">交换机 - 发布/订阅模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#死信队列" class="router-link-active router-link-exact-active toc-link level2">死信队列</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#概念-5" class="router-link-active router-link-exact-active toc-link level3">概念</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#来源" class="router-link-active router-link-exact-active toc-link level3">来源</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#死信实战" class="router-link-active router-link-exact-active toc-link level3">死信实战</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#延迟队列" class="router-link-active router-link-exact-active toc-link level2">延迟队列</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#概念-6" class="router-link-active router-link-exact-active toc-link level3">概念</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#延迟队列使用场景" class="router-link-active router-link-exact-active toc-link level3">延迟队列使用场景</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#rabbitmq-中的-ttl" class="router-link-active router-link-exact-active toc-link level3">RabbitMQ 中的 TTL</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#springboot-整合-rabbitmq" class="router-link-active router-link-exact-active toc-link level2">SpringBoot 整合 RabbitMQ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#发布确认高级" class="router-link-active router-link-exact-active toc-link level2">发布确认高级</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#存在的问题" class="router-link-active router-link-exact-active toc-link level3">存在的问题</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#发布确认springboot版本" class="router-link-active router-link-exact-active toc-link level3">发布确认SpringBoot版本</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#备份交换机" class="router-link-active router-link-exact-active toc-link level3">备份交换机</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#其它知识点" class="router-link-active router-link-exact-active toc-link level2">其它知识点</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#幂等性" class="router-link-active router-link-exact-active toc-link level3">幂等性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#优先级队列" class="router-link-active router-link-exact-active toc-link level3">优先级队列</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#惰性队列" class="router-link-active router-link-exact-active toc-link level3">惰性队列</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#rabbitmq集群" class="router-link-active router-link-exact-active toc-link level2">RabbitMQ集群</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#集群形式" class="router-link-active router-link-exact-active toc-link level3">集群形式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#haproxy-keepalived实现高可用的负载均衡" class="router-link-active router-link-exact-active toc-link level3">HAPROXY+KEEPALIVED实现高可用的负载均衡</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#federation-exchange-联邦交换机" class="router-link-active router-link-exact-active toc-link level3">Federation Exchange(联邦交换机)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#federation-queue-联邦队列" class="router-link-active router-link-exact-active toc-link level3">Federation Queue(联邦队列)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/code/RabbitMQ.html#shovel" class="router-link-active router-link-exact-active toc-link level3">Shovel</a></li><!----><!--]--></ul></li><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><!-- more --><h1 id="rabbitmq学习笔记" tabindex="-1"><a class="header-anchor" href="#rabbitmq学习笔记" aria-hidden="true">#</a> RabbitMQ学习笔记</h1><h2 id="相关网站" tabindex="-1"><a class="header-anchor" href="#相关网站" aria-hidden="true">#</a> 相关网站</h2><p><a href="https://www.bilibili.com/video/BV1cb4y1o7zz/" target="_blank" rel="noopener noreferrer">尚硅谷RabbitMQ学习视频<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://www.rabbitmq.com/" target="_blank" rel="noopener noreferrer">RabbitMQ官网<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://www.rabbitmq.com/download.html" target="_blank" rel="noopener noreferrer">RabbitMQ安装DOC<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://blog.csdn.net/cuierdan/category_11721744.html" target="_blank" rel="noopener noreferrer">RabbitMQ-崔二旦<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="使用mq的好处" tabindex="-1"><a class="header-anchor" href="#使用mq的好处" aria-hidden="true">#</a> 使用MQ的好处</h2><ol><li><strong>项目解耦</strong>：不同的项目或模块可以使用消息中间件进行数据的传递，从而可以保证模块的相对独立，实现解耦。</li><li><strong>流量削峰</strong>：可以将突发的流量 (如秒杀数据) 写入消息中间件，然后由多个消费者进行异步处理。</li><li><strong>弹性伸缩</strong>：可以通过对消息中间件进行横向扩展来提高系统的处理能力和吞吐量。</li><li><strong>发布订阅</strong>：可以用于任意的发布订阅模式中。</li><li><strong>异步处理</strong>：当我们不需要对数据进行立即处理，或者不关心数据的处理结果时，可以使用中间件进行异步处理。</li><li><strong>冗余存储</strong>：消息中间件可以对数据进行持久化存储，直到你消费完成后再进行删除。</li></ol><h2 id="mq的分类" tabindex="-1"><a class="header-anchor" href="#mq的分类" aria-hidden="true">#</a> MQ的分类</h2><table><thead><tr><th>MQ种类</th><th>优点</th><th>缺点</th><th>使用场景</th></tr></thead><tbody><tr><td>ActiveMQ</td><td>单机吞吐量万级，时效性 ms 级，可用性高，基于主从架构实现高可用性，消息可靠性较低的概率丢失数据</td><td>官方社区现在对 ActiveMQ 5.x 维护越来越少，高吞吐量场景较少使用。</td><td>ActiveMQ支持任何消息传递用例的能力和灵活性,<strong>比较适合小型吞吐量比较小的公司进行使用,或者MQ起步学习的首选。</strong></td></tr><tr><td>Kafka</td><td>性能卓越，单机写入TPS 约在百万条/秒，最大的优点，就是吞吐量高。时效性 ms 级可用性非常高，kafka 是分布式的，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用,消费者采用 Pull 方式获取消息, 消息有序, 通过控制能够保证所有消息被消费且仅被消费一次;有优秀的第三方Kafka</td><td>Kafka 单机超过 64 个队列/分区，Load 会发生明显的飙高现象，队列越多，load 越高，发送消息响应时间变长，使用短轮询方式，实时性取决于轮询间隔时间，消费失败不支持重试；支持消息顺序，但是一台代理宕机后，就会产生消息乱序，社区更新较慢；</td><td>Kafka 主要特点是基于Pull 的模式来处理消息消费，追求高吞吐量，<strong>一开始的目的就是用于日志收集和传输，适合产生大量数据的互联网服务的数据收集业务</strong>。大型公司建议可以选用，大数据分析必备，如果有日志采集功能，肯定是首选 kafka 了。</td></tr><tr><td>RocketMQ</td><td>布式的，扩展性好,支持 10 亿级别的消息堆积，不会因为堆积导致性能下降，源码是 java 我们可以自己阅读源码，定制自己公司的 MQ</td><td>支持的客户端语言不多，目前是java及c++，其中c++不成熟，核心中去实现 JMS 等接口,有些系统要迁移需要修改大量代码</td><td><strong>天生为金融互联网领域而生，对于可靠性要求很高的场景</strong>，尤其是电商里面的订单扣款，以及业务削峰，在大量交易涌入时，后端可能无法及时处理的情况。RoketMQ 在稳定性上可能更值得信赖，这些业务场景在阿里双 11 已经经历了多次考验，如果你的业务有上述并发场景，建议可以选择 RocketMQ。</td></tr><tr><td>RabbitMQ</td><td>由于 erlang 语言的高并发特性，性能较好；吞吐量到万级，MQ 功能比较完备,健壮、稳定、易用、跨平台、支持多种语言 如：Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP等，支持 AJAX 文档齐全；开源提供的管理界面非常棒，用起来很好用,社区活跃度高；更新频率相当高</td><td>商业版需要收费,学习成本较高</td><td>结合 erlang 语言本身的并发优势，性能好时效性微秒级，社区活跃度也比较高，管理界面用起来十分方便，<strong>如果你的数据量没有那么大，中小型公司优先选择功能比较完备的 RabbitMQ。</strong></td></tr></tbody></table><h2 id="四大核心概念" tabindex="-1"><a class="header-anchor" href="#四大核心概念" aria-hidden="true">#</a> 四大核心概念</h2><ol><li><p>生产者</p><p>产生数据发送消息的程序</p></li><li><p>交换机</p><p>是 RabbitMQ 非常重要的一个部件，一方面它接收来自生产者的消息，另一方面它将消息 推送到队列中。交换机必须确切知道如何处理它接收到的消息，是将这些<a href="https://so.csdn.net/so/search?q=%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">消息推送<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>到特定队列还是推送到多个队列，亦或者是把消息丢弃，这个得有交换机类型决定</p></li><li><p>队列</p><p>是 RabbitMQ 内部使用的一种数据结构，尽管消息流经 RabbitMQ 和应用程序，但它们只能存储在队列中。队列仅受主机的内存和磁盘限制的约束，本质上是一个大的消息缓冲区。许多生产者可以将消息发送到一个队列，许多消费者可以尝试从一个队列接收数据。这就是我们使用队列的方式</p></li><li><p>消费者</p><p>消费与接收具有相似的含义。消费者大多时候是一个等待接收消息的程序。请注意生产者，消费者和消息中间件很多时候并不在同一机器上。同一个应用程序既可以是生产者又是可以是消费者。</p></li></ol><h2 id="rabbitmq-模型架构" tabindex="-1"><a class="header-anchor" href="#rabbitmq-模型架构" aria-hidden="true">#</a> RabbitMQ 模型架构</h2><figure><img src="/assets/image-20230411155227013-98bfe9a2.png" alt="image-20230411155227013" tabindex="0" loading="lazy"><figcaption>image-20230411155227013</figcaption></figure><ol><li><p>Publisher（发布者）</p><p>发布者 (或称为生产者) 负责生产消息并将其投递到指定的交换器上。</p></li><li><p>Message（消息）</p><p>消息由消息头和消息体组成。消息头用于存储与消息相关的元数据：如目标交换器的名字 (exchange_name) 、路由键 (RountingKey) 和其他可选配置 (properties) 信息。消息体为实际需要传递的数据。</p></li><li><p>Exchange（交换器）</p><p>交换器负责接收来自生产者的消息，并将将消息路由到一个或者多个队列中，如果路由不到，则返回给生产者或者直接丢弃，这取决于交换器的 mandatory 属性：</p><p>当 mandatory 为 true 时：如果交换器无法根据自身类型和路由键找到一个符合条件的队列，则会将该消息返回给生产者；</p><p>当 mandatory 为 false 时：如果交换器无法根据自身类型和路由键找到一个符合条件的队列，则会直接丢弃该消息。</p></li><li><p>BindingKey (绑定键）</p><p>交换器与队列通过 BindingKey 建立绑定关系。</p></li><li><p>Routingkey（路由键）</p><p>生产者将消息发给交换器的时候，一般会指定一个 RountingKey，用来指定这个消息的路由规则。当 RountingKey 与 BindingKey 基于交换器类型的规则相匹配时，消息被路由到对应的队列中。</p></li><li><p>Queue（消息队列）</p><p>用于存储路由过来的消息。多个消费者可以订阅同一个消息队列，此时队列会将收到的消息将以轮询 (round-robin) 的方式分发给所有消费者。即每条消息只会发送给一个消费者，不会出现一条消息被多个消费者重复消费的情况。</p></li><li><p>Consumer（消费者）</p><p>消费者订阅感兴趣的队列，并负责消费存储在队列中的消息。为了保证消息能够从队列可靠地到达消费者，RabbitMQ 提供了消息确认机制 (message acknowledgement)，并通过 autoAck 参数来进行控制：</p><p>当 autoAck 为 true 时：此时消息发送出去 (写入TCP套接字) 后就认为消费成功，而不管消费者是否真正消费到这些消息。当 TCP 连接或 channel 因意外而关闭，或者消费者在消费过程之中意外宕机时，对应的消息就丢失。因此这种模式可以提高吞吐量，但会存在数据丢失的风险。</p><p>当 autoAck 为 false 时：需要用户在数据处理完成后进行手动确认，只有用户手动确认完成后，RabbitMQ 才认为这条消息已经被成功处理。这可以保证数据的可靠性投递，但会降低系统的吞吐量。</p></li><li><p>Connection（连接）</p><p>用于传递消息的 TCP 连接。</p></li><li><p>Channel（信道）</p><p>RabbitMQ 采用类似 NIO (非阻塞式 IO ) 的设计，通过 Channel 来复用 TCP 连接，并确保每个 Channel 的隔离性，就像是拥有独立的 Connection 连接。当数据流量不是很大时，采用连接复用技术可以避免创建过多的 TCP 连接而导致昂贵的性能开销。</p></li><li><p>Virtual Host（虚拟主机）</p><p>RabbitMQ 通过虚拟主机来实现逻辑分组和资源隔离，一个虚拟主机就是一个小型的 RabbitMQ 服务器，拥有独立的队列、交换器和绑定关系。用户可以按照不同业务场景建立不同的虚拟主机，虚拟主机之间是完全独立的，你无法将 vhost1 上的交换器与 vhost2 上的队列进行绑定，这可以极大的保证业务之间的隔离性和数据安全。默认的虚拟主机名为 / 。</p></li><li><p>Broker</p><p>一个真实部署运行的 RabbitMQ 服务。</p></li></ol><h2 id="安装" tabindex="-1"><a class="header-anchor" href="#安装" aria-hidden="true">#</a> 安装</h2><p><a href="https://www.rabbitmq.com/download.html" target="_blank" rel="noopener noreferrer">RabbitMQ安装文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>Docker安装：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span> rabbitmq <span class="token punctuation">\</span>
  <span class="token parameter variable">-e</span> <span class="token assign-left variable">RABBITMQ_DEFAULT_USER</span><span class="token operator">=</span>test <span class="token parameter variable">-e</span> <span class="token assign-left variable">RABBITMQ_DEFAULT_PASS</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-p</span> <span class="token number">5671</span>:5671 <span class="token parameter variable">-p</span> <span class="token number">5672</span>:5672 <span class="token parameter variable">-p</span> <span class="token number">4369</span>:4369 <span class="token parameter variable">-p</span> <span class="token number">25672</span>:25672 <span class="token parameter variable">-p</span> <span class="token number">15671</span>:15671 <span class="token parameter variable">-p</span> <span class="token number">15672</span>:15672 <span class="token punctuation">\</span>
  <span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token punctuation">\</span>
  rabbitmq:management
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>安装好后通过 15672 端口就能访问到管理页面。</p><h2 id="rabbitmq工作模式" tabindex="-1"><a class="header-anchor" href="#rabbitmq工作模式" aria-hidden="true">#</a> RabbitMQ工作模式</h2><h3 id="helloworld-简单队列模式" tabindex="-1"><a class="header-anchor" href="#helloworld-简单队列模式" aria-hidden="true">#</a> HelloWorld - 简单队列模式</h3><h4 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍" aria-hidden="true">#</a> 介绍</h4><p>简单队列模式从字面上理解,乍看就是一种非常简单的队列模式,其实实际也是如此,该队列模式分为两种角色,一个是消息生产者,另外一个是消息消费者,最后还有一个队列,俗称点对点模式。</p><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-304-0" aria-selected="true">生产者代码</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-304-1" aria-selected="false">消费者代码</button></div><!--[--><div class="tab-item active" id="tab-304-0" role="tabpanel" aria-expanded="true"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorld</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">HELLO_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;hello_world&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建RabbitMQ连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取信道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 声明一个队列:
         * 1. 队列名称
         * 2. 队列里面的消息是否持久化到磁盘，默认为false，不持久化
         * 3. 该队列是否只提供一个消费者进行消费，是否进行消息共享
         * 4. 最后一个消费者断开连接以后，是否自动删除
         * 5. 其它配置消息
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">HELLO_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 发送消息到MQ:
         * 1. 交换机
         * 2. 路由的key，本次是队列名称
         * 3. 其它配置消息
         * 4. 发送的消息体
         */</span>
        <span class="token class-name">String</span> sendMsg <span class="token operator">=</span> <span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">HELLO_QUEUE</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> sendMsg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/assets/image-20230411112719993-3df6d6d1.png" alt="image-20230411112719993" tabindex="0" loading="lazy"><figcaption>image-20230411112719993</figcaption></figure></div><div class="tab-item" id="tab-304-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">HELLO_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;hello_world&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建RabbitMQ连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取信道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 消费一个消息:
         * 1. 队列名称
         * 2. 消费成功之后是否自动应答，true为自动应答，false为手动应答
         * 3. 接收消息的回调
         * 4. 消费者取消消费的回调
         */</span>
        <span class="token class-name">String</span> receiveConsumerTag <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">HELLO_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumerTag = &quot;</span> <span class="token operator">+</span> consumerTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;message = &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumerTag = &quot;</span> <span class="token operator">+</span> consumerTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;receiveConsumerTag = &quot;</span> <span class="token operator">+</span> receiveConsumerTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/assets/image-20230411113802184-01331669.png" alt="image-20230411113802184" tabindex="0" loading="lazy"><figcaption>image-20230411113802184</figcaption></figure></div><!--]--></div></details><h3 id="work-queues-工作队列模式" tabindex="-1"><a class="header-anchor" href="#work-queues-工作队列模式" aria-hidden="true">#</a> Work Queues - 工作队列模式</h3><h4 id="介绍-1" tabindex="-1"><a class="header-anchor" href="#介绍-1" aria-hidden="true">#</a> 介绍</h4><ol><li><p>工作队列模式 也叫 竞争消费者模式</p><ul><li><p>多个消费端消费同一个队列中的消息</p></li><li><p>队列采用轮询的方式将消息是平均发送给消费者，此处的资源是竞争关系</p></li></ul></li><li><p>与简单模式相比 多了一个(或者多个)消费端</p></li><li><p>它解决了当消息队列的消息过多的情况，单消费者消费速率有限，导致的消息堆积的问题。</p></li><li><p>工作队列模式中的队列是和默认的交换机 AMQP default 进行绑定(和简单模式一样)</p></li><li><p>保证同一个消息只能被一个消费者消费掉</p><ul><li>可以设置一个开关，syncronize，保证一条消息只能被一个消费者使用</li></ul></li><li><p>用于场景</p><ul><li><p>红包场景</p></li><li><p>大型项目中的资源调度</p></li></ul></li></ol><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-389-0" aria-selected="true">生产者代码</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-389-1" aria-selected="false">消费者1代码</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-389-2" aria-selected="false">消费者2代码</button></div><!--[--><div class="tab-item active" id="tab-389-0" role="tabpanel" aria-expanded="true"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">WORK_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;work&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建RabbitMQ连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取信道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 声明一个队列:
         * 1. 队列名称
         * 2. 队列里面的消息是否持久化到磁盘，默认为false，不持久化
         * 3. 该队列是否只提供一个消费者进行消费，是否进行消息共享
         * 4. 最后一个消费者断开连接以后，是否自动删除
         * 5. 其它配置消息
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">WORK_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 发送消息到MQ:
         * 1. 交换机
         * 2. 路由的key，本次是队列名称
         * 3. 其它配置消息
         * 4. 发送的消息体
         */</span>
        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">WORK_QUEUE</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-389-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Worker01</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">WORK_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;work&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建RabbitMQ连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取信道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消费消息</span>
        <span class="token doc-comment comment">/**
         * 消费一个消息:
         * 1. 队列名称
         * 2. 消费成功之后是否自动应答，true为自动应答，false为手动应答
         * 3. 接收消息的回调
         * 4. 消费者取消消费的回调
         */</span>
        <span class="token class-name">String</span> receiveConsumerTag <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">WORK_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumerTag = &quot;</span> <span class="token operator">+</span> consumerTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;message = &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumerTag = &quot;</span> <span class="token operator">+</span> consumerTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;receiveConsumerTag = &quot;</span> <span class="token operator">+</span> receiveConsumerTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-389-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Worker01</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">WORK_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;work&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建RabbitMQ连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取信道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消费消息</span>
        <span class="token doc-comment comment">/**
         * 消费一个消息:
         * 1. 队列名称
         * 2. 消费成功之后是否自动应答，true为自动应答，false为手动应答
         * 3. 接收消息的回调
         * 4. 消费者取消消费的回调
         */</span>
        <span class="token class-name">String</span> receiveConsumerTag <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">WORK_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumerTag = &quot;</span> <span class="token operator">+</span> consumerTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;message = &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumerTag = &quot;</span> <span class="token operator">+</span> consumerTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;receiveConsumerTag = &quot;</span> <span class="token operator">+</span> receiveConsumerTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--]--></div></details><h3 id="消息应答" tabindex="-1"><a class="header-anchor" href="#消息应答" aria-hidden="true">#</a> 消息应答</h3><h4 id="概念" tabindex="-1"><a class="header-anchor" href="#概念" aria-hidden="true">#</a> 概念</h4><p>消费者完成一个任务可能需要一段时间，如果其中一个消费者处理一个长的任务并仅只完成了部分突然它挂掉了，会发生什么情况。RabbitMQ一旦向消费者传递了一条消息，便立即将该消息标记为删除。在这种情况下，突然有个消费者挂掉了，我们将丢失正在处理的消息。以及后续发送给该消费这的消息，因为它无法接收到。</p><p><strong>为了保证消息在发送过程中不丢失，rabbitmq引入消息应答机制，消息应答就是:消费者在接收到消息并且处理该消息之后，告诉rabbitmq它已经处理了，rabbitmq可以把该消息删除了。</strong></p><h4 id="自动应答" tabindex="-1"><a class="header-anchor" href="#自动应答" aria-hidden="true">#</a> 自动应答</h4><p>消息发送后立即被认为已经传送成功，这种模式需要在**高吞吐量和数据传输安全性方面做权衡,**因为这种模式如果消息在接收到之前，消费者那边出现连接或者channel关闭，那么消息就丢失了,当然另一方面这种模式消费者那边可以传递过载的消息，**没有对传递的消息数量进行限制，**当然这样有可能使得消费者这边由于接收太多还来不及处理的消息，导致这些消息的积压，最终使得内存耗尽，最终这些消费者线程被操作系统杀死，<strong>所以这种模式仅适用在消费者可以高效并以某种速率能够处理这些消息的情况下使用。</strong></p><h4 id="手动应答" tabindex="-1"><a class="header-anchor" href="#手动应答" aria-hidden="true">#</a> 手动应答</h4><ul><li><p>Channel.basicAck(用于肯定确认) RabbitMQ已知道该消息并且成功的处理消息，可以将其丢弃了</p></li><li><p>Channel.basicNack(用于否定确认)</p></li><li><p>Channel.basicReject(用于否定确认) 与Channel.basicNack相比少一个参数 不处理该消息了直接拒绝，可以将其丢弃了</p></li></ul><p><strong>手动应答的好处是可以批量应答并且减少网络拥堵</strong></p><h5 id="代码" tabindex="-1"><a class="header-anchor" href="#代码" aria-hidden="true">#</a> 代码</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Worker03</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">WORK_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;work&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
 
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         * 消费一个消息:
         * 1. 队列名称
         * 2. 消费成功之后是否自动应答，true为自动应答，false为手动应答
         * 3. 接收消息的回调
         * 4. 消费者取消消费的回调
         */</span>
        <span class="token class-name">String</span> receiveConsumerTag <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">WORK_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                   <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;开始休眠1s...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 1.消息标记</span>
            <span class="token comment">// 2.false 代表只应答接收到的哪个传递的信息，true为应答所有的消息包括传递过来的消息</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getEnvelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到的消息&quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumerTag = &quot;</span> <span class="token operator">+</span> consumerTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;receiveConsumerTag = &quot;</span> <span class="token operator">+</span> receiveConsumerTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="multiple" tabindex="-1"><a class="header-anchor" href="#multiple" aria-hidden="true">#</a> Multiple</h5><p>multiple的true和false代表不同意思：</p><ul><li><p>true代表批量应答channel上未应答的消息 比如说channel上有传送tag的消息 5,6,7,8 当前tag是8 ，那么此时 5-8的这些还未应答的消息都会被确认收到消息应答</p></li><li><p>false同上面相比（通常用false）</p></li></ul><h5 id="消息自动重新入队" tabindex="-1"><a class="header-anchor" href="#消息自动重新入队" aria-hidden="true">#</a> 消息自动重新入队</h5><p>如果消费者由于某些原因失去连接(其通道已关闭，连接已关闭或TCP连接丢失)，导致消息未发送ACK确认，RabbitMQ将了解到消息未完全处理，并将对其重新排队。如果此时其他消费者可以处理，它将很快将其重新分发给另一个消费者。这样，即使某个消费者偶尔死亡，也可以确保不会丢失任何消息。</p><figure><img src="/assets/8b9fc154217a46e2abb7a1db86937c78-cf940fe0.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h3 id="rabbitmq持久化" tabindex="-1"><a class="header-anchor" href="#rabbitmq持久化" aria-hidden="true">#</a> RabbitMQ持久化</h3><h5 id="概念-1" tabindex="-1"><a class="header-anchor" href="#概念-1" aria-hidden="true">#</a> 概念</h5><p>将队列和消息设置为持久化，保存到磁盘上，这样RabbitMQ服务停止之后，生产者发过来的消息不会丢失。</p><h5 id="队列持久化" tabindex="-1"><a class="header-anchor" href="#队列持久化" aria-hidden="true">#</a> 队列持久化</h5><p>声明队列的时候需要将队列设置为持久化</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 队列持久化，设置 durable=true</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">WORK_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="消息持久化" tabindex="-1"><a class="header-anchor" href="#消息持久化" aria-hidden="true">#</a> 消息持久化</h5><p>发布消息的时候要设置消息持久化</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 消息持久化，设置额外参数为 MessageProperties.PERSISTENT_TEXT_PLAIN</span>
channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">WORK_QUEUE</span><span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT_TEXT_PLAIN</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="不公平分发" tabindex="-1"><a class="header-anchor" href="#不公平分发" aria-hidden="true">#</a> 不公平分发</h5><h6 id="概念-2" tabindex="-1"><a class="header-anchor" href="#概念-2" aria-hidden="true">#</a> 概念</h6><p>rabbitMq默认是公平分发的，即轮询分发，有多少个消费者，多少个消费者平均消费消费。但是在工作中，我们希望消费速度快的机器就消费更多的消息。这时候我们可以在消费者设置<strong>channel.basicQos(1)</strong>；不公平分发，来让消费速度快的消费者消费更多的消息。意思就是如果这个任务我还没有处理完或者我还没有应答你，你先别分配给我，我目前只能处理一个任务，然后 rabbitmq 就会把该任务分配给没有那么忙的那个空闲消费者。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code> // prefetchCount为1表示不公平分发,0表示公平分发,大于1表示预取值
channel.basicQos(prefetchCount);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="缺点" tabindex="-1"><a class="header-anchor" href="#缺点" aria-hidden="true">#</a> 缺点</h6><p>如果所有的消费者都没有完成手上任务，队列还在不停的添加新任务，队列有可能就会遇到队列被撑满的情况，这个时候就只能添加新的 worker 或者改变其他存储任务的策略。</p><h5 id="预取值" tabindex="-1"><a class="header-anchor" href="#预取值" aria-hidden="true">#</a> 预取值</h5><h3 id="发布确认-防止发送时消息丢失" tabindex="-1"><a class="header-anchor" href="#发布确认-防止发送时消息丢失" aria-hidden="true">#</a> 发布确认(防止发送时消息丢失)</h3><p><a href="https://blog.csdn.net/cuierdan/article/details/124013373" target="_blank" rel="noopener noreferrer">RabbitMQ学习记录(五)-发布确认机制<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>发布确认机制也就是发送方确认模式，生产者在Channel(信道)上调用confirmSelect()方法，请求将Broker的Channel(信道)设置成为confirm模式，一旦信道进入confirm模式，所有在该信道上流通的消息都会被指派一个唯一的ID(从1开始)，并将消息被推送到匹配的队列中。生产者可以在推送消息之后，通过信道调用waitForConfirms()方法，向RabbitMQ发送消息发布确认请求，RabbitMQ服务器会返回消息发布确认的状态给生产者（包括确认的消息及消息的ID信息），这样生产者就知道消息已经被正确推送到目的队列了。如果收到发布确认失败的消息，生产者可以进行后续的重新发送。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 创建信道</span>
<span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 开启confirm模式</span>
channel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="单个确认" tabindex="-1"><a class="header-anchor" href="#单个确认" aria-hidden="true">#</a> 单个确认</h4><p>单个确认是一种简单的确认方式，它是一种同步确认发布的方式，也就是发布一个消息之后，便向Broker发送确认发布请求，只有当这个消息被确认发布之后，才会继续发布后面的消息，一种串行的确认发布过程，这种方式的发布速度特别的慢，因为前面的消息没有被确认发布，就会阻塞后面所有的消息发布。这种方式的吞吐量每秒小于100条。</p><figure><img src="/assets/watermark_type_d3F5LXplbmhlaQ_shadow_50_text_Q1NETiBA5bSU5LqM5pem_size_20_color_FFFFFF_t_70_g_se_x_16-555f73ec.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><ol><li>生产者发送一条消息给Broker。</li><li>生产者向Broker发送一次发布确认请求 。</li><li>Broker向生产者返回确认发布失败(NACK)的状态，生产者重新发送这一条消息。失败可能是Broker服务端出现问题，导致消息无法被发送。</li><li>Broker向生产者返回确认发布成功(ACK)的状态，生产者继续发送下一条消息。</li></ol><h4 id="批量确认" tabindex="-1"><a class="header-anchor" href="#批量确认" aria-hidden="true">#</a> 批量确认</h4><p>批量确认其实是单个确认的一个升级版，因为单个确认的方式是需要一条消息一条消息的确认，发送消息的速度比较慢，如果推送一批消息之后一起确认，这样就会大大提高吞吐量，但是在推送消息的过程中，出现了故障就会导致一些消息丢失，因为在批量确认的时候是一次性确认一批消息，Broker是没有办法返回具体确认状态里消息的信息的，所以出现失败时是不知道丢失的消息是哪个，所以我们要把整批消息记录下来，一边失败后的重新推送。这种批量确认的方式也是同步发送的，也会出现消息阻塞的情况。</p><figure><img src="/assets/watermark_type_d3F5LXplbmhlaQ_shadow_50_text_Q1NETiBA5bSU5LqM5pem_size_20_color_FFFFFF_t_70_g_se_x_16-1681188543175-3-806a7e19.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><ol><li>生产者发送一批消息给Broker。</li><li>生产者向Broker发送一次发布确认请求 。</li><li>Broker向生产者返回确认发布失败(NACK)的状态，生产者重新发送这一批消息，失败可能是Broker服务端出现问题，导致消息无法被发送。</li><li>Broker向生产者返回确认发布成功(ACK)的状态，生产者继续发送下一批消息。</li></ol><h4 id="异步确认" tabindex="-1"><a class="header-anchor" href="#异步确认" aria-hidden="true">#</a> 异步确认</h4><p>Confirm模式最大的好处是可以异步确认，在生产者发送消息之前，在生产者程序中设置一个确认发布监听器，用于给Borker端调用，Broker将确认发布信息推送给生产者确认发布监听器，设置好监听器之后生产者就可以向Broker端推送消息了。确认发布监听器与消息推送是两个独立的线程，所以推送消息和监听状态是可以并行的，也就是所谓的异步操作，生产者可以一直给Broker端推送消息，Broker端会将确认状态通过监听器回调给生产者，Broker端会给确认发布监听器传递两种确认发布的状态，确认成功(Confirm Ack)和确认失败(Confirm Nack)，生产者可以获取到成功或失败的消息，做其它处理，如将失败的消息重新发送。所以异步确认是性价比最好的。</p><figure><img src="/assets/watermark_type_d3F5LXplbmhlaQ_shadow_50_text_Q1NETiBA5bSU5LqM5pem_size_20_color_FFFFFF_t_70_g_se_x_16-1681188571601-6-b13fafd8.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>生产者在将Channel(信道)设置成Confirm模式之后，需要先将确认发布监听器准备好，以便于Broker随时可以将消息的确认状态回调给生产者。</p><ol><li>生产者连续给Broker发送消息。</li><li>Broker在接收到消息之后，随时将确认发布状态回传给生产者的监听器（调用回调函数） 。</li><li>确认发布监听器将发送失败(Nack)的消息，进行处理重新发送。</li><li>确认发布监听器将发送成功(Ack)的消息，进行后续处理，比如进度日志等。</li></ol><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-622-0" aria-selected="true">单个确认</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-622-1" aria-selected="false">批量确认</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-622-2" aria-selected="false">异步确认</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-622-3" aria-selected="false">速度对比</button></div><!--[--><div class="tab-item active" id="tab-622-0" role="tabpanel" aria-expanded="true"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfirmSingle</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_NAME</span><span class="token operator">=</span><span class="token string">&quot;confirm-single&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//开启发布确认的方法</span>
        channel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 1.队列名称
         * 2.是否持久化,true持久化
         * 3.是否共享
         * 4.是否自动删除
         * 5.其它参数
         */</span>
        <span class="token keyword">boolean</span> durable <span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span>durable<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;正在准备发送消息。。。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Scanner</span> scanner<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> message<span class="token operator">=</span>scanner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token doc-comment comment">/**
             * 1.发送到那个交换机
             * 2.队列名称
             * 3.其他参数 消息持久化参数:MessageProperties.PERSISTENT_TEXT_PLAIN
             * 4.要发送的消息体
             */</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT_TEXT_PLAIN</span><span class="token punctuation">,</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//服务端返回false或者超时，可以设置消息重发</span>
            <span class="token keyword">boolean</span> b <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息【&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;】完毕&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-622-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfirmBatch</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> queueName<span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 1.队列名称
         * 2.是否持久化,true持久化
         * 3.是否共享
         * 4.是否自动删除
         * 5.其它参数
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//开启发布确认</span>
        channel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//批量确认消息的大小</span>
        <span class="token keyword">int</span> batchSize<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token comment">//未确认消息个数</span>
        <span class="token keyword">int</span> noaskCount<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">1000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> message<span class="token operator">=</span>i<span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>queueName<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//未确认消息个数减1</span>
            noaskCount<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token comment">//每100个消息，确认一次</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span>batchSize<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                channel<span class="token punctuation">.</span><span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发布消息【&quot;</span><span class="token operator">+</span>message<span class="token operator">+</span><span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-622-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfirmAsync</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 1.队列名称
         * 2.是否持久化,true持久化
         * 3.是否共享
         * 4.是否自动删除
         * 5.其它参数
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//开启发布确认</span>
        channel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//线程安全有序的一个哈希表，适用于高并发的情况</span>
        <span class="token class-name">ConcurrentSkipListMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> concurrentSkipListMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentSkipListMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         *  确认收到消息的回调
         *  1.消息序列号
         *  2.true可以确认小于或等于该序列号的消息
         *    false只确认当前序列号的消息
         */</span>
        <span class="token class-name">ConfirmCallback</span> askCallback <span class="token operator">=</span> <span class="token punctuation">(</span>sequenceNumber<span class="token punctuation">,</span> multiple<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>multiple<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//返回的是小于或等于该序列号的消息</span>
                <span class="token class-name">ConcurrentNavigableMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> longStringConcurrentNavigableMap <span class="token operator">=</span> concurrentSkipListMap<span class="token punctuation">.</span><span class="token function">headMap</span><span class="token punctuation">(</span>sequenceNumber<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> longs <span class="token operator">=</span> longStringConcurrentNavigableMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> key <span class="token operator">:</span> longs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发布的消息【&quot;</span> <span class="token operator">+</span> longStringConcurrentNavigableMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;】被A确认，序列号&quot;</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//清除该部分未确认消息</span>
                longStringConcurrentNavigableMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> message <span class="token operator">=</span> concurrentSkipListMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sequenceNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发布的消息【&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;】被B确认，序列号&quot;</span> <span class="token operator">+</span> sequenceNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//只清除当前序列号的消息</span>
                concurrentSkipListMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>sequenceNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//未确认消息的回调</span>
        <span class="token class-name">ConfirmCallback</span> nackCallback <span class="token operator">=</span> <span class="token punctuation">(</span>sequenceNumber<span class="token punctuation">,</span> multiple<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> concurrentSkipListMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sequenceNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发布的消息&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;未被确认，序列号&quot;</span> <span class="token operator">+</span> sequenceNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         *
         添加一个异步确认的监听器
         * 1.确认收到消息的回调
         * 2.未收到消息的回调
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">addConfirmListener</span><span class="token punctuation">(</span>askCallback<span class="token punctuation">,</span> nackCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;消息&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
            <span class="token doc-comment comment">/**
             * channel.getNextPublishSeqNo()获取下一个消息的序列号
             * 通过序列号与消息体进行一个关联
             * 全部都是未确认的消息体
             */</span>
            concurrentSkipListMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getNextPublishSeqNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> queueName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;确认的消息是【&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-622-3" role="tabpanel" aria-expanded="false"><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>单个确认：发布1000个消息到同一队列,耗时1863ms。
批量确认：发布1000个批量消息到同一队列,耗时150ms。
异步确认：发布1000个异步消息到同一队列,耗时99ms
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--]--></div></details><h2 id="交换机-发布-订阅模式" tabindex="-1"><a class="header-anchor" href="#交换机-发布-订阅模式" aria-hidden="true">#</a> 交换机 - 发布/订阅模式</h2><h4 id="交换机" tabindex="-1"><a class="header-anchor" href="#交换机" aria-hidden="true">#</a> 交换机</h4><h5 id="概念-3" tabindex="-1"><a class="header-anchor" href="#概念-3" aria-hidden="true">#</a> 概念</h5><p>在RabbitMQ中，生产者发送信息不会直接将消息投递到队列中，而是将消息投递到交换机中，再由交换机转发到具体的队列中，队列再将消息以推送或者拉取方式给消费进行消费。</p><h5 id="类型" tabindex="-1"><a class="header-anchor" href="#类型" aria-hidden="true">#</a> 类型</h5><ul><li>直接(direct) - 对应routing路由模式</li><li>主题(topic) - 对应topic 主题模式</li><li>标题(headers)</li><li>扇出(fanout) - 对应 publish/subscribe订阅模式</li><li>默认(default): 是一个空串的交换机</li></ul><h4 id="临时队列" tabindex="-1"><a class="header-anchor" href="#临时队列" aria-hidden="true">#</a> 临时队列</h4><h5 id="概念-4" tabindex="-1"><a class="header-anchor" href="#概念-4" aria-hidden="true">#</a> 概念</h5><p>临时队列是没有持久化的队列。也可以直接随机给队列起一个名字，当消费者断开连接时，队列也会自动删除。</p><h5 id="创建方式" tabindex="-1"><a class="header-anchor" href="#创建方式" aria-hidden="true">#</a> 创建方式</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> queueName <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="绑定-bindings" tabindex="-1"><a class="header-anchor" href="#绑定-bindings" aria-hidden="true">#</a> 绑定(bindings)</h4><p>绑定就是交换机和队列之间的绑定关系。</p><figure><img src="/assets/watermark_type_d3F5LXplbmhlaQ_shadow_50_text_Q1NETiBA5rGf5rW3aQ___size_20_color_FFFFFF_t_70_g_se_x_16-0a6242d0.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><h4 id="fanout-publish-subscribe订阅模式" tabindex="-1"><a class="header-anchor" href="#fanout-publish-subscribe订阅模式" aria-hidden="true">#</a> Fanout - publish/subscribe订阅模式</h4><p>它将接收到的所有消息广播到它知道的所有队列中。</p><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-708-0" aria-selected="true">生产者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-708-1" aria-selected="false">消费者1</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-708-2" aria-selected="false">消费者2</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-708-3" aria-selected="false">结果</button></div><!--[--><div class="tab-item active" id="tab-708-0" role="tabpanel" aria-expanded="true"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerFanout</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;fanout_mq&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span><span class="token string">&quot;fanout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息：&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-708-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer01</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;fanout_mq&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span><span class="token string">&quot;fanout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明临时队列</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 绑定交换机和队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Consumer01等待接收消息...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DeliverCallback</span> callback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Consumer01接收到：&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>callback<span class="token punctuation">,</span>consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-708-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer02</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;fanout_mq&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span><span class="token string">&quot;fanout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明临时队列</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 绑定交换机和队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Consumer02等待接收消息...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DeliverCallback</span> callback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Consumer02接收到：&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>callback<span class="token punctuation">,</span>consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-708-3" role="tabpanel" aria-expanded="false"><p><img src="data:image/png;base64,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" alt="image-20230411133601509" loading="lazy"><img src="data:image/png;base64,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" alt="image-20230411133535946" loading="lazy"><img src="data:image/png;base64,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" alt="image-20230411133546281" loading="lazy"></p></div><!--]--></div></details><h4 id="direct-routing路由模式" tabindex="-1"><a class="header-anchor" href="#direct-routing路由模式" aria-hidden="true">#</a> Direct - routing路由模式</h4><p>指定RoutingKey使得不同的key接收队列的消息。</p><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-732-0" aria-selected="true">生产者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-732-1" aria-selected="false">消费者1</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-732-2" aria-selected="false">消费者2</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-732-3" aria-selected="false">执行结果</button></div><!--[--><div class="tab-item active" id="tab-732-0" role="tabpanel" aria-expanded="true"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerDirect</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;direct_mq&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息：&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-732-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerInfo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;direct_mq&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明一个队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;console&quot;</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 绑定交换机和队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token string">&quot;console&quot;</span><span class="token punctuation">,</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span><span class="token string">&quot;info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ConsumerInfo等待接收消息...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DeliverCallback</span> callback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ConsumerInfo接收到：&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token string">&quot;console&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>callback<span class="token punctuation">,</span>consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-732-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerError</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;direct_mq&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明一个队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;console&quot;</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 绑定交换机和队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token string">&quot;console&quot;</span><span class="token punctuation">,</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ConsumerError等待接收消息...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DeliverCallback</span> callback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ConsumerError接收到：&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token string">&quot;console&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>callback<span class="token punctuation">,</span>consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-732-3" role="tabpanel" aria-expanded="false"><p><img src="data:image/png;base64,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" alt="image-20230411134207577" loading="lazy"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAR8AAAAyCAIAAADqcEhGAAALHklEQVR4nO2caVQUVxbH76umFVEcWRQUPWxubJ2wqoitczAozMSYoI45LscwKoiAbCYgLlEjIc4gCIoGFZfx6LgwcSF6zIxLjBF13EXPuCtuuCAoCNJN15sP3bZldXdVddGlR3y/0x+qX73l1uX9ebdedV2kUjcDgUCQAOpdG0AgtFqIuggEqSDqIhCkgqiLQJAKoi4CQSqIuqTC18ebt4TjLEdl4TWN1hFSX3TnBCZsdWGsfnh01cwvh4cF9x8aHZ/379tNGL8TyyzL09Kpvj7ezE9cabXAtvjZmTXJnw3y9/b18fb2SvmlSahD9GMZlhgqpOLiJYHdsqi4eMki85tbgaaGaInlrR4r1vfma+sSYotlY1K+jXN6fnpTXtJUzcYd6YHt3olxFsQ2LLmkJAbulc3KKh+waNGnLmDr1lFg2/9tnJ1b4TV3aaZHWwCw95TzN9HOOebM0x8bTkdWNWa59sDU9OWtbNbUZxpsynijoxsKj+hNC1tdl/dsu9h76p7ZX7ohhJUBcHlgTtnptIBQhNA7sc9SyJ28Q5wAXztnA2d7KPqF9BR6ORirK29ctwpJG6vsL7CJ4Rxlzk5u1Zk1oYVowJSF+mNmE5bAjNZhYrScBIp63ogMMdZU3bsLnm6uAACAkN2QGSu+H+HWrDv78s6BpUmjPxkYNCBidGLBgUp90Hh0QZB3/KbyDTNGDgwKDR+T+Y/zz1+dwrju/KasCcMGBvr6BA2KnLxgx9VG3alDs3y9U/eoMAYAjJv2pPZVzDoIALi6dLLX1KLNGZEDwmeUXj63eqIyNCJl2/VmXU3V3QMFidFDgv2DwsekFB+tan41lmpfmrffrB3ly2Ij+wcPHD5pfum1F/xRnCnjMa1uamhobGx42QygUTXoaHplhklv8M5LIRPXKHr5MQ+0s1mgtPQaNpQQ0x5m+Go0lNX3ZvgRfjmtHtbahWmaBhnSr1T2XoPDX51TV6yIS9zqOCllYYLD0xPr8hJj6c07khVtdacrS7fbj4zPHvGsfM2S7IT2nntnh7YHADhXnLTw2MfpWQU+dprqUxu/z0hz7Lsrvi+fYVcq6r9Ojan9Nj/DPiY+M3pd5uL1J76YHyoD9bnCyYnbnSal5CTZ15zYkBc7DZVum9JbfyGnt+92iJ6ZM6rq8Kq8rAQbt13pAW14F16jxtfsmh6WdYyiACiA1JAyAACaHpZ/dklEWz5vcO49GF2UDG+feJuwjoVEkqzljnWKWWIYvhp2SNYubtiRIQcVe/91MzBhbfroLghhpY/q/JDifRXJikDd6aYBk+aP95MhrHSvOR61pfzK7FB/AKi9cfVR18iYmEgFQhj3CwiKegydBYxmHxwROdQB71xS5j9q6PDa++tW/1b1DMAezpRtqwxO2pg+2hEhrFSoK5Srd1+Ykuava9fcKSox9fOuCGOle/3pEVsOXk4P8OMdzajxHQfP2rK1HtTleeOWt/tmY5z2Sjv2kAvwhjn3Pxyq4GgoIiDkqGZKddwQIXEjVF0Yv6x68NjGw7ULQgCAkLOrp82j+w+bMG6rXRl6erjqwsxu3d3gydNn2i+d+nj3eLA5N6fbuMF+ffr2dnXy6CDMMLkVAIUosLKSAVAUAhowYPzyyZNaO4/uNo2NDQAAHbp7dnpw/4EKf6xboGTu3Z0BABCiXL37ubZprscAvDdZxoxHckcPhSPGTXftAKzdFAqFQG+YCqJYJczbLXOnqVlKENg5a9NFSCuydnEjfO2iNRqgqNfzFFEUaDSaN77rjgAB1u/je09ekavOX1ucsaHqJWXTQzlpwcLEfo6i90homoZnW+JCtjDKwjXNAG10g7+OAuVhmXv3CuvVlPGmzeDwBndgxipkLXFGWwFj6utbcWygGy6bRnfYufUpJDIkQuKGpS5EURTQNI0xhRAAVF86cKqx9x8DXKyAksmApl9PO0zTIJPJ+AZAyMYjKq0gKq35xePKiv1Fcxakrgg+PLu/DCFKRgGN6Vf9YRooGe/TbYqi4A+R81ZM9HpdZutiLehiLQiPNzieDmkPeHc79PUNt0BYeuMOEc0K9szdwRfX8MPhjdmMkMzZpTvcuF0JAAAY1/5akDC77LYVAELWzl07N9y4/Ui3Y/bw9o2GLt2c2vJtGFRfOrT/ZGUTxlbtO3v0GzsxslvNnXvPAQDA2cUVrt+s1E5RfOvGNXDv4cLdG0LWjo6d6mjbnn5+CoXCz8/HxUatAYp6uw8MeL2h35djfpjlpnoW/UMK4dISeIslZCdQ4Fqq5+nR/LjxsUuPVvMWcpS/R7Ajwz6Ro7xWFWd+1/6vSue6s5uW/trjLxsDtNGWb2S05/rl3yxpOyHIrubkhqJTnmNm+vIOoLqwITWn5vOv4yPcOzRXn9u8665btJcdQgDgGRGtKFo2d5HDFKXjo0M/rr/jnxzhztuh/59Hdxu/JKNY/YWvner2wdW5O53m7Svka6d+eOnMredw704DNN45f/xENdi6BXo5CXgwbAIh3hDxH92s3QXDpUwIpnYOja6TzLMclQ0NM6yA8cvyrSuPnKEObz0WOyDKGiFThRzl7xdsdVn1+qrwRzq3YP28nbXtXANHFhRPC9CFXXLfuKJC9LeilXM2v7BxCxpTuDDWtw3vAM6jFhU+WbxszZwdD+rlDq4fhWfnf6X7O1Hu45auVC3OXzt3V51tz4HTimeOdeX/3aP8o4TiPPRDUW76yob23RXh6SVJnzrytqo7kh8z9wgAAAU/zYn5CSBswW8rox14G5o0Q4A3xG3EiYvlBGrM1K8xWo6pX6LoQcjab9DQLr9f9Bnkp1eL0UKO8vcLRN78fwsIfBLF28QwEuNef1jlvOuV0XJDS0z9dIv7Gj9AiLoIBKkgb6AQCFJB1EUgSAVRF4EgFURdBIJUEHURCFJB1EUgSAVRF4EgFURdBIJUEHURCFJB1EUgSAVRF4EgFURdUsGRgkZIE3Gv/bbwZWGMabVaLeDVbIIgSC5efkTn4mUiInmGIVJnOHvyc3KYIjT558dmtbKIf1olJBcvPyJy8TIxuiKJe21eRB4os6Dk1u1s2reTmxfRtNA/rRiSi5cHcbl4mQcWz5jLfGOS951Fs3AYtvjQMPOaiPDPhwPJxStJLl7pMuYye7BItKmFGTlHFl5knrK4fz4cWDEApmka0Ju5eP1d5AiBLhfvP5+FTFmY+93UkNotibErLqheN60s3X4lKD77h5RPrA5lJxSUN+jKzxUnLTzmMCarYPXqJRl/on7JSFt7WYBhVyrqlakxvU7mZ+yQTciM7nxw8foTNABoc/Fuft4/Pic/Z1pw9frYaWuvahgNT2/f3TR8Zk729NCGsqyEotMqIX9Uo8bX7JoeGBASPCDrPxRdlhoSHBQSHBQUmHFABfzeeIXvmymjWSVG4chwyOrBgjddtmHJJSUlJSV/H+tJGzktmX9aNyQXr2njW5aLV+c0S2fMZfUmfCuSe3Rd5IyrrtjC74anJfNP64bk4gVTxovOxauvJkXGXBZvKYmFNP5p9ZBcvJzGmzaDwxvSZczl3X40igUUaFH/fDiQXLzi4PKGdBlzpd6RtxwiZ0srg+TiFYNZ3pA0Yy5HD8xB33LCd9GzpZVBcvGKRLg3LJsxl1mB2X9LwFjz5Mp/b9YCwNNbddB4t+LE8ToAcOjVz9NepB7EzZZWBsnFKxKzvGGpjLmmni9zI6Bm07HlkzL3a51PwfX5MWUAAJ8tv7hoiMBB2IibLa0Mki3U8ry1jLmmBhVtOcGyEHURCFJB3kAhEKSCqItAkAqiLgJBKv4PSZqvwRkVdHAAAAAASUVORK5CYII=" alt="image-20230411134216154" loading="lazy"><img src="data:image/png;base64,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" alt="image-20230411134224344" loading="lazy"></p></div><!--]--></div></details><h4 id="topic-topic-主题模式" tabindex="-1"><a class="header-anchor" href="#topic-topic-主题模式" aria-hidden="true">#</a> Topic - topic 主题模式</h4><p>上方路由模式中无法同时发送多个队列，在当前topic模式中可以指定多个RoutingKey中间使用英文句号隔开。通配符*代替一个单词；#代表零个或多个单词。</p><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-756-0" aria-selected="true">生产者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-756-1" aria-selected="false">消费者1</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-756-2" aria-selected="false">消费者2</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-756-3" aria-selected="false">执行结果</button></div><!--[--><div class="tab-item active" id="tab-756-0" role="tabpanel" aria-expanded="true"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerTopic</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;topic_logs&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * Q1--&gt;绑定的是
         *      中间带 orange 带 3 个单词的字符串(*.orange.*)
         * Q2--&gt;绑定的是
         *      最后一个单词是 rabbit 的 3 个单词(*.*.rabbit)
         *      第一个单词是 lazy 的多个单词(lazy.#)
         *
         */</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bindingKeyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bindingKeyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;quick.orange.rabbit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;被队列 Q1Q2 接收到&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bindingKeyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;lazy.orange.elephant&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;被队列 Q1Q2 接收到&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bindingKeyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;quick.orange.fox&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;被队列 Q1 接收到&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bindingKeyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;lazy.brown.fox&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;被队列 Q2 接收到&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bindingKeyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;lazy.pink.rabbit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;虽然满足两个绑定但只被队列 Q2 接收一次&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bindingKeyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;quick.brown.fox&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;不匹配任何绑定不会被任何队列接收到会被丢弃&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bindingKeyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;quick.orange.male.rabbit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;是四个单词不匹配任何绑定会被丢弃&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bindingKeyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;lazy.orange.male.rabbit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;是四个单词但匹配 Q2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bindingKeyEntry <span class="token operator">:</span> bindingKeyMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> bindingKey <span class="token operator">=</span> bindingKeyEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> bindingKeyEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> bindingKey<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;生产者发出消息：&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-756-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer01</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;topic_logs&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//声明 Q1 队列与绑定关系</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">&quot;Q1&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//声明</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//绑定</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;*.orange.*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;等待接收消息........... &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DeliverCallback</span> deliverCallback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; 接收队列:&quot;</span> <span class="token operator">+</span> queueName <span class="token operator">+</span> <span class="token string">&quot; 绑定键:&quot;</span> <span class="token operator">+</span> delivery<span class="token punctuation">.</span><span class="token function">getEnvelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRoutingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,消息:&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> deliverCallback<span class="token punctuation">,</span> consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-756-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer02</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;topic_logs&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//声明 Q2 队列与绑定关系</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">&quot;Q2&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//声明</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//绑定</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;*.*.rabbit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;lazy.#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;等待接收消息........... &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DeliverCallback</span> deliverCallback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; 接收队列:&quot;</span> <span class="token operator">+</span> queueName <span class="token operator">+</span> <span class="token string">&quot; 绑定键:&quot;</span> <span class="token operator">+</span> delivery<span class="token punctuation">.</span><span class="token function">getEnvelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRoutingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,消息:&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> deliverCallback<span class="token punctuation">,</span> consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-756-3" role="tabpanel" aria-expanded="false"><blockquote><p>生产者发出消息：是四个单词不匹配任何绑定会被丢弃 生产者发出消息：不匹配任何绑定不会被任何队列接收到会被丢弃 生产者发出消息：被队列 Q1Q2 接收到 生产者发出消息：被队列 Q2 接收到 生产者发出消息：被队列 Q1Q2 接收到 生产者发出消息：被队列 Q1 接收到 生产者发出消息：虽然满足两个绑定但只被队列 Q2 接收一次 生产者发出消息：是四个单词但匹配 Q2</p></blockquote><blockquote><p>等待接收消息........... 接收队列:Q1 绑定键:lazy.orange.elephant,消息:被队列 Q1Q2 接收到 接收队列:Q1 绑定键:quick.orange.rabbit,消息:被队列 Q1Q2 接收到 接收队列:Q1 绑定键:quick.orange.fox,消息:被队列 Q1 接收到</p></blockquote><blockquote><p>等待接收消息........... 接收队列:Q2 绑定键:lazy.orange.elephant,消息:被队列 Q1Q2 接收到 接收队列:Q2 绑定键:lazy.brown.fox,消息:被队列 Q2 接收到 接收队列:Q2 绑定键:quick.orange.rabbit,消息:被队列 Q1Q2 接收到 接收队列:Q2 绑定键:lazy.pink.rabbit,消息:虽然满足两个绑定但只被队列 Q2 接收一次 接收队列:Q2 绑定键:lazy.orange.male.rabbit,消息:是四个单词但匹配 Q2</p></blockquote></div><!--]--></div></details><h2 id="死信队列" tabindex="-1"><a class="header-anchor" href="#死信队列" aria-hidden="true">#</a> 死信队列</h2><h3 id="概念-5" tabindex="-1"><a class="header-anchor" href="#概念-5" aria-hidden="true">#</a> 概念</h3><p>死信，顾名思义就是无法被消费的消息。一般来说，Producer 将消息投递到 Broker 或者直接到 Queue 里了，Consumer 从 Queue 取出消息进行消费，但某些时候由于特定的原因导致 Queue 中的某些消息无法被消费，这样的消息如果没有后续的处理，就变成了死信，有死信自然就有了死信队列。</p><p>应用场景：为了保证订单业务的消息数据不丢失，需要使用到 RabbitMQ 的死信队列机制，档消息消费发生异常时，将消息投入到死信队列中。还有比如说：用户在商城下单成功并点击支付后再指定时间未支付时自动失效。</p><h3 id="来源" tabindex="-1"><a class="header-anchor" href="#来源" aria-hidden="true">#</a> 来源</h3><ul><li>消息 TTL 过期</li><li>队列达到最大长度（队列满了，无法再添加数据到 mq 中）</li><li>消息被拒绝（basic.reject 或 basic.nack）并且 requeue=false（不再重新入队）</li></ul><h3 id="死信实战" tabindex="-1"><a class="header-anchor" href="#死信实战" aria-hidden="true">#</a> 死信实战</h3><h4 id="代码架构图" tabindex="-1"><a class="header-anchor" href="#代码架构图" aria-hidden="true">#</a> 代码架构图</h4><figure><img src="/assets/3be5b60dd12a498d88579c039ce81499-3cd5c0bc.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><h4 id="消息-ttl-过期" tabindex="-1"><a class="header-anchor" href="#消息-ttl-过期" aria-hidden="true">#</a> 消息 TTL 过期</h4><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-830-0" aria-selected="true">生产者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-830-1" aria-selected="false">正常消费者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-830-2" aria-selected="false">死信消费者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-830-3" aria-selected="false">执行结果</button></div><!--[--><div class="tab-item active" id="tab-830-0" role="tabpanel" aria-expanded="true"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;normal_exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">DEAD_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead_exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">DEAD_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead-queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;normal-queue&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// 声明一个死信交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明一个死信队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 死信队列与死信交换机绑定</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明一个普通交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 正常队列与死信交换机的绑定关系</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> deadLetterParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        deadLetterParams<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        deadLetterParams<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> deadLetterParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 把队列和交换机进行绑定</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置消息 TTL 过期时间</span>
        <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expiration</span><span class="token punctuation">(</span><span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">,</span> properties<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成：&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-830-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterConsumer1</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;normal-queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;正常消费者启动等待消费消息：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">String</span> receivedMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;正常消费者接收到消息：&quot;</span> <span class="token operator">+</span> receivedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>consumerTag <span class="token operator">+</span> <span class="token string">&quot;正常消费者取消消费消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-830-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterConsumer2</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">DEAD_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead-queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;死信队列消费者启动等待消费消息：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> receivedMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;死信队列消费者接收到死信：&quot;</span> <span class="token operator">+</span> receivedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>consumerTag <span class="token operator">+</span> <span class="token string">&quot;死信队列消费者取消消费消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-830-3" role="tabpanel" aria-expanded="false"><blockquote><p>消息发送完成：info</p></blockquote><blockquote><p>正常消费者启动等待消费消息： 正常消费者接收到消息：info</p></blockquote><p>当正常消费者挂掉后</p><blockquote><p>死信队列消费者启动等待消费消息： 死信队列消费者接收到死信：info</p></blockquote></div><!--]--></div></details><h4 id="队列达到最大长度" tabindex="-1"><a class="header-anchor" href="#队列达到最大长度" aria-hidden="true">#</a> 队列达到最大长度</h4><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-866-0" aria-selected="true">生产者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-866-1" aria-selected="false">正常消费者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-866-2" aria-selected="false">死信消费者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-866-3" aria-selected="false">执行结果</button></div><!--[--><div class="tab-item active" id="tab-866-0" role="tabpanel" aria-expanded="true"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterLengthProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;normal_exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">DEAD_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead_exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">DEAD_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead-queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;normal-queue&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明一个死信交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明一个死信队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 死信队列与死信交换机绑定</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明一个普通交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 正常队列与死信交换机的绑定关系</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> deadLetterParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        deadLetterParams<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        deadLetterParams<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        deadLetterParams<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-max-length&quot;</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> deadLetterParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 把队列和交换机进行绑定</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;info&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-866-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterLengthConsumer1</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;normal-queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;正常消费者启动等待消费消息：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

            <span class="token class-name">String</span> receivedMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;正常消费者接收到消息：&quot;</span> <span class="token operator">+</span> receivedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>consumerTag <span class="token operator">+</span> <span class="token string">&quot;正常消费者取消消费消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-866-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterLengthConsumer2</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">DEAD_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead-queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;死信队列消费者启动等待消费消息：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> receivedMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;死信队列消费者接收到死信：&quot;</span> <span class="token operator">+</span> receivedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>consumerTag <span class="token operator">+</span> <span class="token string">&quot;死信队列消费者取消消费消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-866-3" role="tabpanel" aria-expanded="false"><blockquote><p>消息发送完成</p></blockquote><blockquote></blockquote><p>当超过队列长度后</p><blockquote><p>死信队列消费者启动等待消费消息： 死信队列消费者接收到死信：info0 死信队列消费者接收到死信：info1 死信队列消费者接收到死信：info2 死信队列消费者接收到死信：info3</p></blockquote></div><!--]--></div></details><h4 id="消息被拒" tabindex="-1"><a class="header-anchor" href="#消息被拒" aria-hidden="true">#</a> 消息被拒</h4><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-899-0" aria-selected="true">生产者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-899-1" aria-selected="false">正常消费者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-899-2" aria-selected="false">死信消费者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-899-3" aria-selected="false">执行结果</button></div><!--[--><div class="tab-item active" id="tab-899-0" role="tabpanel" aria-expanded="true"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterRejectProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;normal_exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">DEAD_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead_exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">DEAD_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead-queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;normal-queue&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明一个死信交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明一个死信队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 死信队列与死信交换机绑定</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明一个普通交换机</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 正常队列与死信交换机的绑定关系</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> deadLetterParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        deadLetterParams<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token constant">DEAD_EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        deadLetterParams<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> deadLetterParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 把队列和交换机进行绑定</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;info&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-899-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterRejectConsumer1</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;normal-queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;正常消费者启动等待消费消息：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> receivedMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;info5&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>receivedMessage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;C1接收到消息：&quot;</span> <span class="token operator">+</span> receivedMessage<span class="token operator">+</span><span class="token string">&quot;并且拒绝签收了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 禁止重新入队</span>
                channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getEnvelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者接收到消息：&quot;</span> <span class="token operator">+</span> receivedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getEnvelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>consumerTag <span class="token operator">+</span> <span class="token string">&quot;正常消费者取消消费消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-899-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterLengthConsumer2</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">DEAD_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;dead-queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitConnectionUtil</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;死信队列消费者启动等待消费消息：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> receivedMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;死信队列消费者接收到死信：&quot;</span> <span class="token operator">+</span> receivedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>consumerTag <span class="token operator">+</span> <span class="token string">&quot;死信队列消费者取消消费消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-899-3" role="tabpanel" aria-expanded="false"><blockquote><p>消息发送完成</p></blockquote><blockquote><p>正常消费者启动等待消费消息： 消费者接收到消息：info0 消费者接收到消息：info1 消费者接收到消息：info2 消费者接收到消息：info3 消费者接收到消息：info4 C1接收到消息：info5并且拒绝签收了 消费者接收到消息：info6 消费者接收到消息：info7 消费者接收到消息：info8 消费者接收到消息：info9</p></blockquote><p>当第5条被拒绝后</p><blockquote><p>死信队列消费者启动等待消费消息： 死信队列消费者接收到死信：info5</p></blockquote></div><!--]--></div></details><h2 id="延迟队列" tabindex="-1"><a class="header-anchor" href="#延迟队列" aria-hidden="true">#</a> 延迟队列</h2><h3 id="概念-6" tabindex="-1"><a class="header-anchor" href="#概念-6" aria-hidden="true">#</a> 概念</h3><p>延迟队列存储的对象是对应的延迟消息，所谓“延迟消息”是指当消息被发送以后，并不想让消费者立刻拿到消息，而是等待特定时间后，消费者才能拿到这个消息进行消费。</p><h3 id="延迟队列使用场景" tabindex="-1"><a class="header-anchor" href="#延迟队列使用场景" aria-hidden="true">#</a> 延迟队列使用场景</h3><ol><li>订单在十分钟之内未支付则自动取消</li><li>新创建的店铺，如果在十天内都没有上传过商品，则自动发送消息提醒。</li><li>用户注册成功后，如果三天内没有登录则进行短信提醒。</li><li>用户发起退款后，如果三天内没有得到处理则通知相关运营人员。</li><li>预定会议后，需要在预定时间点前十分钟通知各个与会人员参加会议。</li></ol><p>这些场景都有一个特点，需要在某个时间发生之后或者之前的指定时间点完成某一项任务，如：发生订单生成事件，在十分钟之后检查该订单支付状态，然后将未支付的订单进行关闭。看起来似乎使用定时任务，一直轮询数据，每秒查一次，然后取出需要被处理的数据进行处理就可以了。如果数据量比较少，确实可以这样做，比如：对于“如果账单一周内未支付则进行自动结算”这样的需求，如果对于时间不是严格限制，而是宽松意义上的一周，那么每天晚上跑个定时任务检查一下所有未支付的账单，确实也是一个可行的方案。但对于数据量比较大，并且时效性较强的场景，如：“订单十分钟内未支付则关闭”，短期内未支付的订单数据可能会很多，活动期间甚至会达到百万甚至千万级别，对这么庞大的数据量仍旧使用轮询的方式显然是不可取的，很可能在一秒内无法完成所有订单的检查，同时会给数据库带来很大压力，无法满足业务要求而且性能低下。</p><figure><img src="/assets/cd0a02591c254339bb22052fd723d52c-ef81e36c.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><h3 id="rabbitmq-中的-ttl" tabindex="-1"><a class="header-anchor" href="#rabbitmq-中的-ttl" aria-hidden="true">#</a> RabbitMQ 中的 TTL</h3><h4 id="设置消息-ttl" tabindex="-1"><a class="header-anchor" href="#设置消息-ttl" aria-hidden="true">#</a> 设置消息 TTL</h4><p>针对每条消息设置 TTL 的方法时在 channel.basicPublish 方法中加入 expiration 的属性参数，单位为毫秒。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 设置消息 TTL 过期时间为 10s</span>
<span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expiration</span><span class="token punctuation">(</span><span class="token string">&quot;10000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">,</span> properties<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="设置队列-ttl" tabindex="-1"><a class="header-anchor" href="#设置队列-ttl" aria-hidden="true">#</a> 设置队列 TTL</h4><p>通过 channel.queueDeclare 方法中的 x-expires 参数可以控制队列被自动删除前处于未使用状态的时间。未使用的意思是队列上没有任何的消费者，队列也没有被重新声明，并且在过期时间段内也未调用过 Basic.get 命令。</p><p>RabbitMQ 会确保在过期时间到达后将队列删除，但是不保障删除的动作有多及时。在 RabbitMQ 重启后，持久化的队列的过期时间会被重新计算。</p><p>用于表示过期时间的 x-expires 参数以毫秒为单位，并且服从和 x-message-ttl 一样的约束条件，不过不能设置为 0。比如该参数设置为 1000，则表示该队列如果在 1 秒钟之内未使用则会被删除。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-expires&quot;</span><span class="token punctuation">,</span> <span class="token number">1800000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;myqueue&quot;</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="两者的区别" tabindex="-1"><a class="header-anchor" href="#两者的区别" aria-hidden="true">#</a> 两者的区别</h4><p>如果设置了队列的 TTL 属性，那么一旦消息过期，就会被队列丢弃（如果配置了死信队列则会被丢到死信队列中），而第二种方式，消息即使过期，也不一定会被马上丢弃，因为消息是否过期是在即将投递到消费者之前判定的，如果当前队列有严重的消息积压情况，则已过期的消息也许还能存活较长时间；另外，还需要注意一点是，如果不设置 TTL，表示消息永远不会过期，如果将 TTL 设置为 0，则表示除非此时可以直接投递该消息到消费者，否则该消息将会别丢弃。</p><h2 id="springboot-整合-rabbitmq" tabindex="-1"><a class="header-anchor" href="#springboot-整合-rabbitmq" aria-hidden="true">#</a> SpringBoot 整合 RabbitMQ</h2><h4 id="添加依赖" tabindex="-1"><a class="header-anchor" href="#添加依赖" aria-hidden="true">#</a> 添加依赖</h4><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.80<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="修改配置文件" tabindex="-1"><a class="header-anchor" href="#修改配置文件" aria-hidden="true">#</a> 修改配置文件</h4><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> IP地址
    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">password</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="队列-ttl" tabindex="-1"><a class="header-anchor" href="#队列-ttl" aria-hidden="true">#</a> 队列 TTL</h4><p>创建两个队列 QA 和 QB，两个队列 TTL 分别设置为 10s 和 40s，然后再创建一个交换机 X 和死信交换机 Y，它们的类型都是 direct，创建一个死信队列 QD，它们的绑定关系如下：</p><figure><img src="/assets/de294941665a48fb999135f231a3d080-3c9f757e.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-1026-0" aria-selected="true">配置文件类代码</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1026-1" aria-selected="false">消息生产者代码</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1026-2" aria-selected="false">消息消费者代码</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1026-3" aria-selected="false">执行结果</button></div><!--[--><div class="tab-item active" id="tab-1026-0" role="tabpanel" aria-expanded="true"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TtlQueueConfig</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 普通交换机名称
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">X_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">&quot;X&quot;</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 死信交换机名称
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">Y_DEAD_LETTER_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">&quot;Y&quot;</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 普通队列名称
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_A</span> <span class="token operator">=</span> <span class="token string">&quot;QA&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_B</span> <span class="token operator">=</span> <span class="token string">&quot;QB&quot;</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 死信队列名称
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_LETTER_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;QD&quot;</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 声明 XExchange
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">xExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token constant">X_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 声明 yExchange
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">yExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token constant">Y_DEAD_LETTER_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 声明队列QA
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queueA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> arguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置死信交换机</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token constant">Y_DEAD_LETTER_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置死信路由键</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;YD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置过期时间</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">QUEUE_A</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 声明队列QB
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queueB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> arguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置死信交换机</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token constant">Y_DEAD_LETTER_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置死信路由键</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;YD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置过期时间</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span> <span class="token number">40000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">QUEUE_B</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withArguments</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 死信队列QD
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queueD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">DEAD_LETTER_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * 绑定
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">queueABindingX</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;queueA&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> queueA<span class="token punctuation">,</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;xExchange&quot;</span><span class="token punctuation">)</span> <span class="token class-name">DirectExchange</span> xExchange<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queueA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>xExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;XA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">queueBBindingX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token constant">QUEUE_B</span><span class="token punctuation">,</span> <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span><span class="token constant">QUEUE</span><span class="token punctuation">,</span> <span class="token constant">X_EXCHANGE</span><span class="token punctuation">,</span> <span class="token string">&quot;XB&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">queueDBindingY</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;queueD&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> queueD<span class="token punctuation">,</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;yExchange&quot;</span><span class="token punctuation">)</span> <span class="token class-name">DirectExchange</span> yExchange<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queueD<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>yExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;YD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1026-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ttl&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMsgController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sendMsg/{message}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前时间：{}发送一条消息{}给两个队列&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;X&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;XA&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;消息来自TTL为10s队列QA：&quot;</span><span class="token operator">+</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;X&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;XB&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;消息来自TTL为40s队列QB：&quot;</span><span class="token operator">+</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;发送成功&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1026-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterConsumer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;QD&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveD</span><span class="token punctuation">(</span><span class="token class-name">Delivery</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前时间{}，收到死信队列的消息：{}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1026-3" role="tabpanel" aria-expanded="false"><blockquote><figure><img src="/assets/d0487df7211e4bb5a0514f028a0d3fd1-b901b1b6.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure></blockquote><p>第一条消息在 10s 后变成了死信消息，然后被消费者消费掉了，第二条消息在 40s 之后变成了死信消息，然后被消费掉，这样一个延时队列就完成了。</p><p>不过，如果这样使用的话，岂不是每增加一个新的时间需求，就要新增一个队列，这里只有 10s 和 40s 两个时间选项，如果需要一个小时后处理，那么就需要增加 TTL 为一个小时的队列，如果是预定会议室，然后提前通知这样的场景，岂不是要增加无数个队列才能满足需求？</p></div><!--]--></div></details><h4 id="延时队列优化" tabindex="-1"><a class="header-anchor" href="#延时队列优化" aria-hidden="true">#</a> 延时队列优化</h4><h5 id="代码架构图-1" tabindex="-1"><a class="header-anchor" href="#代码架构图-1" aria-hidden="true">#</a> 代码架构图</h5><p>在这里新增了一个队列 QC，绑定关系如下，该队列不设置 TTL 时间</p><figure><img src="/assets/6db9152e6be64470bb6453073cd74241-d76ea1d3.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-1064-0" aria-selected="true">配置文件类代码</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1064-1" aria-selected="false">消息生产者代码</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1064-2" aria-selected="false">消息消费者代码</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1064-3" aria-selected="false">执行结果</button></div><!--[--><div class="tab-item active" id="tab-1064-0" role="tabpanel" aria-expanded="true"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MsgTtlQueueConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">Y_DEAD_LETTER_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">&quot;Y&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_C</span> <span class="token operator">=</span> <span class="token string">&quot;QC&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;queueC&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queueC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> arguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明当前队列绑定的死信交换机</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token constant">Y_DEAD_LETTER_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 声明当前队列的私信路由key</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;YD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">QUEUE_C</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">queueCBindingX</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;queueC&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> queueC<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;xExchange&quot;</span><span class="token punctuation">)</span> <span class="token class-name">DirectExchange</span> xExchange<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queueC<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>xExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;XC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1064-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ttl&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMsgController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sendExpirationMsg/{message}/{ttlTime}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> ttlTime<span class="token punctuation">)</span><span class="token punctuation">{</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;X&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;XC&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token punctuation">(</span>messagePostProcessor<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            messagePostProcessor<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>ttlTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> messagePostProcessor<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">/* MessagePostProcessor messagePostProcessor = new MessagePostProcessor() {
            @Override
            public Message postProcessMessage(Message message) throws AmqpException {
                message.getMessageProperties().setExpiration(ttlTime);
                return message;
            }
        };
        rabbitTemplate.convertAndSend(&quot;X&quot;, &quot;XC&quot;, message, messagePostProcessor);
*/</span>        <span class="token keyword">return</span> <span class="token string">&quot;发送成功&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1064-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterConsumer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;Y&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveD</span><span class="token punctuation">(</span><span class="token class-name">Delivery</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前时间{}，收到死信队列的消息：{}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1064-3" role="tabpanel" aria-expanded="false"><blockquote><figure><img src="/assets/c1dbc20d6a454b14856bc57063f8d83e-929ee0b7.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure></blockquote><p>两条消息的过期时间一致，过期时间短的那条消息，在过期时间到了以后并没有立即被消费，而是和过期时间长的那条消息一起被消费了。所以，如果使用在消息属性上设置 TTL 的方式，消息可能并不会按时“死亡”，因为 RabbitMQ 只会检查第一个消息是否过期，如果过期则丢到死信队列，如果第一个消息的延时时长很长，而第二个消息的延时时长很短，第二个消息并不会优先得到执行。</p></div><!--]--></div></details><h4 id="rabbitmq-插件实现延迟队列" tabindex="-1"><a class="header-anchor" href="#rabbitmq-插件实现延迟队列" aria-hidden="true">#</a> Rabbitmq 插件实现延迟队列</h4><h5 id="docker-安装延时队列插件" tabindex="-1"><a class="header-anchor" href="#docker-安装延时队列插件" aria-hidden="true">#</a> Docker 安装延时队列插件</h5><p><a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases" target="_blank" rel="noopener noreferrer">插件下载地址<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#下载插件</span>
<span class="token function">wget</span> <span class="token parameter variable">-c</span> https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/3.9.0/rabbitmq_delayed_message_exchange-3.9.0.ez
<span class="token comment"># 拷贝插件</span>
<span class="token function">docker</span> <span class="token function">cp</span> /opt/soft-ware/rabbitmq_delayed_message_exchange-3.9.0.ez  rabbitmq:/opt/rabbitmq/plugins/
<span class="token comment"># 进入容器内</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq <span class="token function">bash</span>
<span class="token comment"># 查看插件列表</span>
rabbitmq-plugins list 
<span class="token comment"># 开启插件支持 </span>
rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_delayed_message_exchange
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/assets/image-20230411144724539-bd3bafe3.png" alt="image-20230411144724539" tabindex="0" loading="lazy"><figcaption>image-20230411144724539</figcaption></figure><h5 id="代码架构图-2" tabindex="-1"><a class="header-anchor" href="#代码架构图-2" aria-hidden="true">#</a> 代码架构图</h5><p>在这里新增了一个队列 delayed.queue，一个自定义交换机 delayed.exchange，绑定关系如下：</p><figure><img src="/assets/16c153f33bd64cf1ac5705da6ea7a4d4-8532f115.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-1109-0" aria-selected="true">配置文件类代码</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1109-1" aria-selected="false">消息生产者代码</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1109-2" aria-selected="false">消息消费者代码</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1109-3" aria-selected="false">执行结果</button></div><!--[--><div class="tab-item active" id="tab-1109-0" role="tabpanel" aria-expanded="true"><p>在我们自定义的交换机中，这是一种新的交换机类型，该类型消息支持延迟投递机制，消息传递后并不会立即投递到目标队列中，而是存储在 mnesia（一个分布式数据系统）表中，当达到投递时间时，才投递到目标队列中。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelayedQueueConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DELAYED_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;delayed.queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DELAYED_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;delayed.exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DELAYED_ROUTING_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;delayed.routingKey&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;delayedQueue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">delayedQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">DELAYED_QUEUE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 自定义交换机 定义一个延迟交换机
     *  不需要死信交换机和死信队列，支持消息延迟投递，消息投递之后没有到达投递时间，是不会投递给队列
     *  而是存储在一个分布式表，当投递时间到达，才会投递到目标队列
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;delayedExchange&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CustomExchange</span> <span class="token function">delayedExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自定义交换机的类型</span>
        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-delayed-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;direct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomExchange</span><span class="token punctuation">(</span><span class="token constant">DELAYED_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;x-delayed-message&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingDelayedQueue</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;delayedQueue&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> delayedQueue<span class="token punctuation">,</span>
                                       <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;delayedExchange&quot;</span><span class="token punctuation">)</span> <span class="token class-name">CustomExchange</span> delayedExchange<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>delayedQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>delayedExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">DELAYED_ROUTING_KEY</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1109-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ttl&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMsgController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DELAYED_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;delayed.exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DELAYED_ROUTING_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;delayed.routingKey&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sendDelayMsg/{message}/{delayTime}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> delayTime<span class="token punctuation">)</span><span class="token punctuation">{</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">DELAYED_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token constant">DELAYED_ROUTING_KEY</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> messagePostProcessor <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            messagePostProcessor<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDelay</span><span class="token punctuation">(</span>delayTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> messagePostProcessor<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前时间：{}，发送一条延迟{}毫秒的信息给队列delay.queue:{}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delayTime<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;发送成功&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1109-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLetterConsumer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DELAYED_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;delayed.queue&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token constant">DELAYED_QUEUE_NAME</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveDelayedQueue</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前时间：{}，收到延时队列的消息：{}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1109-3" role="tabpanel" aria-expanded="false"><blockquote><figure><img src="/assets/c5b5ad97cc9148ec86d1d473a8b7cfe9-2982b8ac.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure></blockquote></div><!--]--></div></details><h4 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h4><p>延时队列在需要延时处理的场景下非常有用，使用 RabbitMQ 来实现延时队列可以很好地利用 RabbitMQ 的特性，如：消息可靠发送、消息可靠投递、死信队列，来保证消息至少被消费一次以及未被正确处理的消息不会被丢弃。另外，通过 RabbitMQ 集群的特性，可以很好要的解决单点故障问题，不会因为单个节点挂掉导致延时队列不可用或者消息丢失。</p><h2 id="发布确认高级" tabindex="-1"><a class="header-anchor" href="#发布确认高级" aria-hidden="true">#</a> 发布确认高级</h2><h3 id="存在的问题" tabindex="-1"><a class="header-anchor" href="#存在的问题" aria-hidden="true">#</a> 存在的问题</h3><p>再生产环境中由于一些不明原因导致<code>rabbitmq</code>重启，在<code>RabbitMQ</code>重启期间生产者消息投递失败，会导致消息丢失。</p><h3 id="发布确认springboot版本" tabindex="-1"><a class="header-anchor" href="#发布确认springboot版本" aria-hidden="true">#</a> 发布确认SpringBoot版本</h3><h4 id="确认机制方案" tabindex="-1"><a class="header-anchor" href="#确认机制方案" aria-hidden="true">#</a> 确认机制方案</h4><figure><img src="/assets/image-20230411145409373-d8ce2eed.png" alt="image-20230411145409373" tabindex="0" loading="lazy"><figcaption>image-20230411145409373</figcaption></figure><p>当消息不能正常被接收的时候，我们需要将消息存放在缓存中。</p><h4 id="代码架构图-3" tabindex="-1"><a class="header-anchor" href="#代码架构图-3" aria-hidden="true">#</a> 代码架构图</h4><figure><img src="/assets/bf0d95d0a6e84c7da6bb20a8e34dd98c-e6643fa1.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-1165-0" aria-selected="true">配置文件</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1165-1" aria-selected="false">配置类</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1165-2" aria-selected="false">回调接口</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1165-3" aria-selected="false">生产者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1165-4" aria-selected="false">消费者</button></div><!--[--><div class="tab-item active" id="tab-1165-0" role="tabpanel" aria-expanded="true"><ol><li>none：默认值，禁用发布确认</li><li>correlated：发布消息到交换机后触发回调方法</li><li>simple：有两种效果：第一种效果与correlated一样；其二，单个确认，在发布消息成功后使用rabbitTemplate,调用waitForConfirms或 waitForConfirmsOrDie方法等待broker节点返回发送结果，根据返回结果来判定下一步的逻辑，要注意的点是waitForConfirmsOrDie方法如果返回false则会关闭channel，则接下来无法发送消息到broker。</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> IP地址
    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">password</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /test
    <span class="token key atrule">publisherConfirms</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">publisherReturns</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">#publisher-confirm-type: correlated</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1165-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfirmConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;confirm_exchange&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;confirm_queue&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_ROUTING_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;key1&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;confirmExchange&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">confirmExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;confirmQueue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">confirmQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_QUEUE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">queueBindingExchange</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;confirmExchange&quot;</span><span class="token punctuation">)</span> <span class="token class-name">DirectExchange</span> confirmExchange<span class="token punctuation">,</span> <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;confirmQueue&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> confirmQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>confirmQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>confirmExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_ROUTING_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1165-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCallBack</span> <span class="token keyword">implements</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 交换机接受失败后进行回调
     * 1. 保存消息的ID及相关消息
     * 2. 是否接收成功
     * 3. 接受失败的原因
     */</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> <span class="token class-name">String</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> id <span class="token operator">=</span> correlationData <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;交换机已经收到id为：{}的消息&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;交换机还未收到id为：{}消息，由于原因：{}&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1165-3" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/confirm&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;confirm_exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sendMessage/{message}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">CorrelationData</span> correlationData1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> routingKey1 <span class="token operator">=</span> <span class="token string">&quot;key1&quot;</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_EXCHANGE_NAME</span><span class="token punctuation">,</span>routingKey1<span class="token punctuation">,</span>message <span class="token operator">+</span> routingKey1<span class="token punctuation">,</span>correlationData1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CorrelationData</span> correlationData2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> routingKey2 <span class="token operator">=</span> <span class="token string">&quot;key2&quot;</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_EXCHANGE_NAME</span><span class="token punctuation">,</span>routingKey2<span class="token punctuation">,</span>message <span class="token operator">+</span> routingKey2<span class="token punctuation">,</span>correlationData2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;发送得内容是：{}&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1165-4" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfirmConsumer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;confirm_queue&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token constant">CONFIRM_QUEUE_NAME</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;接收到队列&quot;</span> <span class="token operator">+</span> <span class="token constant">CONFIRM_QUEUE_NAME</span> <span class="token operator">+</span> <span class="token string">&quot;消息：{}&quot;</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--]--></div></details><h4 id="回退消息" tabindex="-1"><a class="header-anchor" href="#回退消息" aria-hidden="true">#</a> 回退消息</h4><h5 id="mandatory参数" tabindex="-1"><a class="header-anchor" href="#mandatory参数" aria-hidden="true">#</a> Mandatory参数</h5><p>Mandatory译为强制性的。**在仅开启生产者确认机制的情况下，交换机接收到消息后，会直接给消息生产者发送确认消息，如果发现该消息不可路由，也就是交换机通过routingKey找不到对应的队列，那么此消息会被直接丢弃，此时，生产者是不知道消息被丢弃的。**如何让无法被路由的消息被处理；通过设置Mandatory参数可以在当消息传递的过程中不可路由时，将消息返回给生产者。</p><h5 id="编码实现" tabindex="-1"><a class="header-anchor" href="#编码实现" aria-hidden="true">#</a> 编码实现</h5><p>实现RabbitTemplate.ReturnCallback接口，并实现其的方法returnedMessage</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCallBack</span> <span class="token keyword">implements</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span><span class="token punctuation">,</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ReturnCallback</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 交换机接收到消息后的回调方法
     *
     * <span class="token keyword">@param</span> <span class="token parameter">correlationData</span> 保存了回调的消息ID及相关信息
     * <span class="token keyword">@param</span> <span class="token parameter">ack</span>             true/false：成功/失败
     * <span class="token keyword">@param</span> <span class="token parameter">cause</span>           失败原因
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> <span class="token class-name">String</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> id <span class="token operator">=</span> correlationData <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;交换机成功收到了ID为：{}的消息&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;交换机未收到了ID为：{}的消息，原因为：{}&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 当消息不可路由时，返回给生产者
     *
     * <span class="token keyword">@param</span> <span class="token parameter">message</span>    消息
     * <span class="token keyword">@param</span> <span class="token parameter">replyCode</span>  退回码
     * <span class="token keyword">@param</span> <span class="token parameter">replyText</span>  退回原因
     * <span class="token keyword">@param</span> <span class="token parameter">exchange</span>   交换机
     * <span class="token keyword">@param</span> <span class="token parameter">routingKey</span> routingKey
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">returnedMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token keyword">int</span> replyCode<span class="token punctuation">,</span> <span class="token class-name">String</span> replyText<span class="token punctuation">,</span> <span class="token class-name">String</span> exchange<span class="token punctuation">,</span> <span class="token class-name">String</span> routingKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;消息：{}，被交换机：{}退回，退回原因：{}，路由Key:{}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                  exchange<span class="token punctuation">,</span> replyText<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="备份交换机" tabindex="-1"><a class="header-anchor" href="#备份交换机" aria-hidden="true">#</a> 备份交换机</h3><p>在上面我们提到如果生产者的消息发送到交换机，在发送的过程中出现了问题，并没有发送到交换机；我们需要进行消息的回退，让消息回退到生产者。这只是一种解决方法，还有一种较好的方法是增加一台备份交换机。让消息不在回退到消费者，而是发送到备份交换机上。</p><h4 id="案例" tabindex="-1"><a class="header-anchor" href="#案例" aria-hidden="true">#</a> 案例</h4><p>增加备份交换机，并在发送失败时提供警告功能</p><figure><img src="/assets/76e20bb706d54517885d0deae36b1cbd-05bb1c2c.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><details class="hint-container details"><summary>示例代码</summary><div class="tab-list"><div class="tab-list-nav" role="tablist"><button type="button" class="tab-list-nav-item active" role="tab" aria-controls="tab-1232-0" aria-selected="true">配置类</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1232-1" aria-selected="false">备份消费者</button><button type="button" class="tab-list-nav-item" role="tab" aria-controls="tab-1232-2" aria-selected="false">报警消费者</button></div><!--[--><div class="tab-item active" id="tab-1232-0" role="tabpanel" aria-expanded="true"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BingConf</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">&quot;confirm_exchange&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;confirm_queue&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_ROTING_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;confirm_routing_key&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BACKUP_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">&quot;backup_exchange&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BACKUP_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;backup_queue&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">WARNING_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;warning_queue&quot;</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;c_ex&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">confirmChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">DirectExchange</span><span class="token punctuation">)</span><span class="token class-name">ExchangeBuilder</span><span class="token punctuation">.</span><span class="token function">directExchange</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">withArgument</span><span class="token punctuation">(</span><span class="token string">&quot;alternate-exchange&quot;</span><span class="token punctuation">,</span><span class="token constant">BACKUP_EXCHANGE</span><span class="token punctuation">)</span>
                                              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;b_ex&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">backupChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token constant">BACKUP_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;c_qu&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">confirmQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;b_qu&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">backupQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">BACKUP_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;w_qu&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">warningQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">WARNING_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingQueueAndExchange</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;c_ex&quot;</span><span class="token punctuation">)</span> <span class="token class-name">DirectExchange</span> exchange<span class="token punctuation">,</span>
                                           <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;c_qu&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_ROTING_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingBackupQueueAndBackupExchange</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;b_ex&quot;</span><span class="token punctuation">)</span> <span class="token class-name">FanoutExchange</span> exchange<span class="token punctuation">,</span>
                                                 <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;b_qu&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> backQueue<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>backQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingWarningQueueAndBackupExchange</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;b_ex&quot;</span><span class="token punctuation">)</span> <span class="token class-name">FanoutExchange</span> exchange<span class="token punctuation">,</span>
                                                 <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;w_qu&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> warningQueue<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>warningQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1232-1" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BackupConsumer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">BingConf</span><span class="token punctuation">.</span><span class="token constant">BACKUP_QUEUE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveConfirmMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;备份消费者接收到消息：{}&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="tab-item" id="tab-1232-2" role="tabpanel" aria-expanded="false"><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WarningConsumer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">BingConf</span><span class="token punctuation">.</span><span class="token constant">WARNING_QUEUE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveConfirmMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;报警消费者接收到消息：{}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--]--></div></details><p>注：当回退消息和备份交换机在配置文件application.properties同时存在时，<strong>优先使用备份交换机</strong></p><h2 id="其它知识点" tabindex="-1"><a class="header-anchor" href="#其它知识点" aria-hidden="true">#</a> 其它知识点</h2><h3 id="幂等性" tabindex="-1"><a class="header-anchor" href="#幂等性" aria-hidden="true">#</a> 幂等性</h3><p>用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。</p><p>用户购买商品后支付，支付扣款成功，但是返回结果的时候网络异常，此时钱已经扣了，用户再次点击按钮，此时会进行第二次扣款，返回结果成功，用户查询余额发现多扣钱了，流水记录也变成了两条。在以前的单应用系统中，我们只需要把数据操作放入事务中即可，发生错误立即回滚，但是再响应客户端的时候也有可能出现网络中断或者异常等等。</p><p><strong>消息重复消费：</strong></p><p>消费者在消费MQ中的消息时，MQ已把消息发送给消费者，消费者在给MQ 返回 ack 时网络中断，故MQ未收到确认信息，该条消息会重新发给其他的消费者，或者在网络重连后再次发送给该消费者，但实际上该消费者已成功消费了该条消息，造成消费者消费了重复的消息。</p><p><strong>解决思路：</strong></p><p>MQ消费者的幂等性的解决一般使用全局ID、唯一标识（比如时间戳）、UUID，订单消费者每次消费消息时用该 id 先判断该消息是否已消费过。</p><p><strong>消费端的幂等性保障：</strong></p><p>在海量订单生成的业务高峰期，生产端有可能会重复发出消息，这时候消费端就要实现幂等性，这就意味着即使收到了一样的消息，消息永远不会被消费多次。</p><p>业界主流的幂等性有两种操作：</p><ol><li><p>唯一 ID+指纹码机制，利用数据库主键去重</p><blockquote><p>指纹码：一些规则或者时间戳加别的服务给到的唯一信息码，它并不一定是系统生成的，基本都是由业务规则拼接而来，但是一定要保证唯一性，然后判断这个 id 是否存在数据库中，优势就是实现简单就一个拼接，查询判断是否重复；劣势就是在高并发时，如果是单个数据库就会有写入性能瓶颈，也可以采用分库分表提升性能，但不是最推荐的方式。</p></blockquote></li><li><p>利用 redis 的原子性去实现</p><blockquote><p>利用 redis 执行 setnx 命令，天然具有幂等性。从而实现不重复消费。</p></blockquote></li></ol><h3 id="优先级队列" tabindex="-1"><a class="header-anchor" href="#优先级队列" aria-hidden="true">#</a> 优先级队列</h3><p>比如在系统中有一个订单催付的场景，客户在天猫下订单，如果在设定的时间内未付款，那么就会给客户推送一条短信提醒。比如像苹果，小米这样大商家，他们的订单得到优先处理，redis的定时轮询只能用List做一个简简单单的消息队列，并不能实现一个优先级的场景。</p><p>订单量大了后采用 RabbitMQ 进行改造和优化，如果发现是大商家的订单给一个相对比较高的优先级，否则就是默认优先级。</p><p><strong>添加优先级队列</strong></p><p>要让队列实现优先级需要做的事情：</p><ol><li>队列需要设置为优先级队列</li><li>需要设置消息的优先级</li><li>消费者需要等待消息已经发送到队列中才去消费，这样才有机会对消息进行排序</li></ol><figure><img src="/assets/80e6f6bae7f36c868a1505363f1065ba-5d2ab91c.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p><strong>控制台页面添加</strong></p><figure><img src="/assets/d78cc4a86fa248c7e20e66d55594fe60-c9c82a4d.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p><strong>代码中队列添加</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-max-priority&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>代码中消息添加</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">priority</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>案例</strong></p><p>消息发布者：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 设置队列的最大优先级 最大可以设置到 255 官网推荐 1-10 如果设置太高比较吃内存和 CPU</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-max-priority&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 给消息赋予一个 priority 属性</span>
        <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">priority</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;info&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> properties<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息完成:&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>消息接受者：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者启动等待消费..............&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DeliverCallback</span> deliverCallback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> receivedMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到消息:&quot;</span> <span class="token operator">+</span> receivedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> deliverCallback<span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者无法消费消息时调用，如队列被删除&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="惰性队列" tabindex="-1"><a class="header-anchor" href="#惰性队列" aria-hidden="true">#</a> 惰性队列</h3><p>RabbitMQ 从 3.6.0 版本开始引入了惰性队列的概念。</p><p>惰性队列会尽可能的将消息存入磁盘中，而在消费者消费到相应的消息时才会被加载到内存中，它的一个重要的设计目标是能够支持更长的队列，即支持更多的消息存储。当消费者由于各种各样的原因(比如消费者下线、宕机亦或者是由于维护而关闭等)而致使长时间内不能消费消息造成堆积时，惰性队列就很有必要了。</p><p>默认情况下，生产者将消息发送到 RabbitMQ 的时候，队列中的消息会尽可能的存储在内存之中，这样可以更加快速的将消息发送给消费者。即使是持久化的消息，在被写入磁盘的同时也会在内存中驻留一份备份。当 RabbitMQ 需要释放内存的时候，会将内存中的消息换页至磁盘中，这个操作会耗费较长的时间，也会阻塞队列的操作，进而无法接收新的消息。</p><p>虽然 RabbitMQ 的开发者们一直在升级相关的算法，但是效果始终不太理想，尤其是在消息量特别大的时候。</p><p><strong>两种模式</strong></p><p><strong>队列具备两种模式：default 和 lazy。</strong></p><p>默认的为default 模式，在3.6.0 之前的版本无需做任何变更。lazy模式即为惰性队列的模式，可以通过调用channel.queueDeclare方法的时候在参数中设置，也可以通过Policy的方式设置，如果一个队列同时使用这两种方式设置的话，那么Policy的方式具备更高的优先级。</p><p>如果要通过声明的方式改变已有队列的模式的话，那么只能先删除队列，然后再重新声明一个新的。</p><p>在队列声明的时候可以通过x-queue-mode参数来设置队列的模式，取值为default和lazy。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-queue-mode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lazy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;myqueue&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>内存开销对比</strong></p><figure><img src="/assets/5bb3f19d237d742acc8af35e38f0f267-c54899ac.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>在发送一百万条消息，每条消息大概占1KB的情况下，普通队列占用内存是1.2GB，而惰性队列仅仅占用1.5MB。</p><h2 id="rabbitmq集群" tabindex="-1"><a class="header-anchor" href="#rabbitmq集群" aria-hidden="true">#</a> RabbitMQ集群</h2><h3 id="集群形式" tabindex="-1"><a class="header-anchor" href="#集群形式" aria-hidden="true">#</a> 集群形式</h3><h4 id="普通模式-默认" tabindex="-1"><a class="header-anchor" href="#普通模式-默认" aria-hidden="true">#</a> 普通模式(默认)</h4><p>对于普通模式， <strong>集群中各节点有相同的队列结构</strong>， 但<strong>消息只会存在于集群中的一个节点</strong>。 对于消费者来说， 若消息进入 A 节点的 Queue 中， 当从 B 节点拉取时， RabbitMQ 会将消息从 A 中取出， 并经过 B 发送给消费者。</p><blockquote><p>应用场景： <strong>该模式各适合于消息无需持久化的场合</strong>， 如日志队列。 当队列非持久化， 且创建该队列的节点宕机， 客户端才可以重连集群其他节点， 并重新创建队列。 <strong>若为持久化，只能等故障节点恢复</strong>。</p></blockquote><h5 id="搭建-docker" tabindex="-1"><a class="header-anchor" href="#搭建-docker" aria-hidden="true">#</a> 搭建(Docker)</h5><h6 id="首先创建容器映射目录" tabindex="-1"><a class="header-anchor" href="#首先创建容器映射目录" aria-hidden="true">#</a> 首先创建容器映射目录</h6><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#创建rabbitmq用于存放rabbitmq集群映射信息</span>
<span class="token function">mkdir</span> /mydata/rabbitmq
<span class="token comment">#分别创建各集群映射目录</span>
<span class="token builtin class-name">cd</span> rabbitmq/
<span class="token function">mkdir</span> rabbitmq01 rabbitmq02 rabbitmq03

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="启动集群镜像容器" tabindex="-1"><a class="header-anchor" href="#启动集群镜像容器" aria-hidden="true">#</a> 启动集群镜像容器</h6><p>rabbitmq01：15673</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--hostname</span> rabbitmq01 <span class="token parameter variable">--name</span> rabbitmq01 <span class="token parameter variable">-v</span> /mydata/rabbitmq/rabbitmq01:/var/lib/rabbitmq <span class="token parameter variable">-p</span> <span class="token number">15673</span>:15672 <span class="token parameter variable">-p</span> <span class="token number">5673</span>:5672 <span class="token parameter variable">-e</span> <span class="token assign-left variable">RABBITMQ_ERLANG_COOKIE</span><span class="token operator">=</span><span class="token string">&#39;zr&#39;</span> rabbitmq:3.8.2-management
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>rabbitmq02： 15674</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--hostname</span> rabbitmq02 <span class="token parameter variable">--name</span> rabbitmq02 -v/mydata/rabbitmq/rabbitmq02:/var/lib/rabbitmq <span class="token parameter variable">-p</span> <span class="token number">15674</span>:15672 <span class="token parameter variable">-p</span> <span class="token number">5674</span>:5672 <span class="token parameter variable">-e</span> <span class="token assign-left variable">RABBITMQ_ERLANG_COOKIE</span><span class="token operator">=</span><span class="token string">&#39;zr&#39;</span> <span class="token parameter variable">--link</span> rabbitmq01:rabbitmq01 rabbitmq:3.8.2-management
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>rabbitmq03： 15675</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--hostname</span> rabbitmq03 <span class="token parameter variable">--name</span> rabbitmq03 <span class="token parameter variable">-v</span> /mydata/rabbitmq/rabbitmq03:/var/lib/rabbitmq <span class="token parameter variable">-p</span> <span class="token number">15675</span>:15672 <span class="token parameter variable">-p</span> <span class="token number">5675</span>:5672 <span class="token parameter variable">-e</span> <span class="token assign-left variable">RABBITMQ_ERLANG_COOKIE</span><span class="token operator">=</span><span class="token string">&#39;zr&#39;</span> <span class="token parameter variable">--link</span> rabbitmq01:rabbitmq01 <span class="token parameter variable">--link</span> rabbitmq02:rabbitmq02 rabbitmq:3.8.2-management
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>注意事项:</p><p>–hostname 设置容器的主机名</p><p>RABBITMQ_ERLANG_COOKIE 节点认证作用， 部署集成时 需要同步该值</p><p>RABBITMQ_ERLANG_COOKIE 为rabbitmq多节点之间通信所用到的cookie，rabbitmq集群就是利用这一特性实现的</p></blockquote><h6 id="节点加入集群" tabindex="-1"><a class="header-anchor" href="#节点加入集群" aria-hidden="true">#</a> 节点加入集群</h6><blockquote><p>设置rabbitmq01为主节点</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq01 /bin/bash
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl start_app
<span class="token builtin class-name">exit</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>将rabbitmq02加入rabbitmq01</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq02 /bin/bash
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster <span class="token parameter variable">--ram</span> rabbit@rabbitmq01
rabbitmqctl start_app
<span class="token builtin class-name">exit</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>将rabbitmq02加入rabbitmq01</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq03 <span class="token function">bash</span>
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster <span class="token parameter variable">--ram</span> rabbit@rabbitmq01
rabbitmqctl start_app
<span class="token builtin class-name">exit</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>最后能看到其他节点信息也就成功了(普通模式)</p></blockquote><h4 id="镜像模式" tabindex="-1"><a class="header-anchor" href="#镜像模式" aria-hidden="true">#</a> 镜像模式</h4><p><strong>与普通模式不同之处是消息实体会主动在镜像节点间同步， 而不是在取数据时临时拉取</strong>， 高可用； 该模式下， mirror queue 有一套选举算法， 即 1 个 master、 n 个 slaver， <strong>生产者、 消费者的请求都会转至 master</strong>。</p><blockquote><p>应用场景： 可靠性要求较高场合， 如下单、 库存队列。 缺点： 若镜像队列过多， 且消息体量大， 集群内部网络带宽将会被此种同步通讯所消耗。 （1） 镜像集群也是基于普通集群， 即只有先搭建普通集群， 然后才能设置镜像队列。 （2） 若消费过程中， master 挂掉， 则选举新 master， 若未来得及确认， 则可能会重复消费。</p></blockquote><h5 id="搭建" tabindex="-1"><a class="header-anchor" href="#搭建" aria-hidden="true">#</a> 搭建</h5><blockquote><p>在普通模式集群的条件下才能搭建镜像集群,并且需要选择一个主节点,此处我们选择rabbitmq01为主节</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#进入rabbitmq01容器</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> rabbitmq01 <span class="token function">bash</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>首先查看此时的策略什么,发现为空,默认普通模式</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl list_policies <span class="token parameter variable">-p</span> /
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>增加镜像模式策略</p><p>ha-mode： all 即复制到所有节点， 包含新增节点。exactly 是指定模式，为exactly时可以指定ha-params ，这个值为备份指定份数</p><p>策略正则表达式为 “^” 表示所有匹配所有队列名称，“^hello”表示只匹配名为 hello 开始的队列</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl set_policy <span class="token parameter variable">-p</span> / ha <span class="token string">&quot;^&quot;</span> <span class="token string">&#39;{&quot;ha-mode&quot;:&quot;all&quot;,&quot;ha-sync-mode&quot;:&quot;automatic&quot;}&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>查看此时的策略</p></blockquote><figure><img src="/assets/a6586804ecd7f5a3c694acd8a350a751-d9faca52.png" alt="image-20220215153454610" tabindex="0" loading="lazy"><figcaption>image-20220215153454610</figcaption></figure><p><strong>镜像模式由于是同步的,当rabbitma01宕机后客户端是直接可以向其他节点拿到消息的</strong></p><h3 id="haproxy-keepalived实现高可用的负载均衡" tabindex="-1"><a class="header-anchor" href="#haproxy-keepalived实现高可用的负载均衡" aria-hidden="true">#</a> HAPROXY+KEEPALIVED实现高可用的负载均衡</h3><h4 id="架构图" tabindex="-1"><a class="header-anchor" href="#架构图" aria-hidden="true">#</a> 架构图</h4><figure><img src="/assets/image-20230411163307310-3526629f.png" alt="image-20230411163307310" tabindex="0" loading="lazy"><figcaption>image-20230411163307310</figcaption></figure><h4 id="haproxy实现负载均衡" tabindex="-1"><a class="header-anchor" href="#haproxy实现负载均衡" aria-hidden="true">#</a> Haproxy实现负载均衡</h4><p><a href="https://www.bbsmax.com/A/pRdBPZ36Jn/" target="_blank" rel="noopener noreferrer">参考资料1<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://blog.csdn.net/li68686/article/details/110127607/" target="_blank" rel="noopener noreferrer">参考资料2<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h5 id="下载haproxy" tabindex="-1"><a class="header-anchor" href="#下载haproxy" aria-hidden="true">#</a> 下载haproxy</h5><p><a href="https://src.fedoraproject.org/repo/pkgs/haproxy/" target="_blank" rel="noopener noreferrer">Haproxy国内镜像<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>查看内核版本：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">uname</span> <span class="token parameter variable">-r</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>根据内核版本选择编译参数：</p><figure><img src="/assets/webp-8a9ad440.webp" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>这里内核是3.10的选择 linux2628，安装haproxy</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">useradd</span> <span class="token parameter variable">-r</span> haproxy
<span class="token function">wget</span> https://src.fedoraproject.org/repo/pkgs/haproxy/haproxy-1.8.12.tar.gz/sha512/2b782a54988cc88d1af0e5f011af062910e8fac28eab13db7e05a58d0d23961f827da47e3871e8d081f5a2d222588480d81dec2e9f14ec9f54a1c3cb5bf3d56a/haproxy-1.8.12.tar.gz
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> haproxy-1.8.12.tar.gz
<span class="token builtin class-name">cd</span>  haproxy-1.8.12
<span class="token function">make</span> <span class="token assign-left variable">TARGET</span><span class="token operator">=</span>linux2628 <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/local/haproxy
<span class="token function">make</span> <span class="token function">install</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/local/haproxy
<span class="token builtin class-name">cd</span> /usr/local/haproxy
<span class="token function">chown</span> <span class="token parameter variable">-R</span> haproxy.haproxy *
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> haproxy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>安装成功后，查看版本：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>/usr/local/haproxy/sbin/haproxy <span class="token parameter variable">-v</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="配置haproxy" tabindex="-1"><a class="header-anchor" href="#配置haproxy" aria-hidden="true">#</a> 配置Haproxy</h5><p>HAProxy配置文件通常分为三个部分，即global、defaults和listen。global为全局配置，defaults为默认配置，listen为应用组件配置。</p><p>global为全局配置部分，属于进程级别的配置，通常和使用的操作系统配置相关。</p><p>defaults配置项配置默认参数，会被应用组件继承，如果在应用组件中没有特别声明，将使用默认配置参数。</p><p>以配置RabbitMQ集群的负载均衡为例，在安装目录下面新建一个haproxy.cfg，输入下面配置信息：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>cd /usr/local/haproxy
touch haproxy.cfg
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>配置内容为:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>global
  <span class="token comment">#日志输出配置，所有日志都记录在本机，通过local0输出</span>
  log <span class="token number">127.0</span>.0.1 local0 info
  <span class="token comment">#最大连接数</span>
  maxconn <span class="token number">10240</span>
  <span class="token comment">#以守护进程方式运行</span>
  daemon
defaults
  <span class="token comment">#应用全局的日志配置</span>
  log global
  mode http
  <span class="token comment">#超时配置</span>
  <span class="token function">timeout</span> connect <span class="token number">5000</span>
  <span class="token function">timeout</span> client <span class="token number">5000</span>
  <span class="token function">timeout</span> server <span class="token number">5000</span>
  <span class="token function">timeout</span> check <span class="token number">2000</span>
listen http_front <span class="token comment">#haproxy的客户页面</span>
  <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:8888
  mode http
  option httplog
  stats uri /haproxy
  stats auth admin:123456
  stats refresh 5s
  stats <span class="token builtin class-name">enable</span>
listen haproxy <span class="token comment">#负载均衡的名字</span>
  <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:5666 <span class="token comment">#对外提供的虚拟的端口</span>
  option tcplog
  mode tcp
  <span class="token comment">#轮询算法</span>
  balance roundrobin
  server rabbit1 <span class="token number">1.117</span>.149.141:5673 check inter <span class="token number">5000</span> rise <span class="token number">2</span> fall <span class="token number">2</span>
  server rabbit2 <span class="token number">1.117</span>.149.141:5674 check inter <span class="token number">5000</span> rise <span class="token number">2</span> fall <span class="token number">2</span>
  server rabbit3 <span class="token number">1.117</span>.149.141:5675 check inter <span class="token number">5000</span> rise <span class="token number">2</span> fall <span class="token number">2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>/usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/haproxy.cfg
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>进入管理页面：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://ip:8888/haproxy
账户:admin
密码:123456
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="keepalived配置高可用" tabindex="-1"><a class="header-anchor" href="#keepalived配置高可用" aria-hidden="true">#</a> KeepAlived配置高可用</h4><p>Keepalived，它是一个高性能的服务器高可用或热备解决方案，Keepalived主要来防止服务器单点故障的发生问题，可以通过其与Nginx、Haproxy等反向代理的负载均衡服务器配合实现web服务端的高可用。Keepalived以VRRP协议为实现基础，用VRRP协议来实现高可用性（HA）。</p><h5 id="下载keepalived" tabindex="-1"><a class="header-anchor" href="#下载keepalived" aria-hidden="true">#</a> 下载KeepAlived</h5><p>Keepalived的官网下载Keepalived的安装文件，，下载地址为<a href="http://www.keepalived.org/download.html%E3%80%82" target="_blank" rel="noopener noreferrer">http://www.keepalived.org/download.html。<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">wget</span> <span class="token parameter variable">-c</span> --no-check-certificate https://www.keepalived.org/software/keepalived-2.2.7.tar.gz
<span class="token function">tar</span> zxvf keepalived-2.2.7.tar.gz
<span class="token builtin class-name">cd</span> keepalived-2.2.7
./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/opt/keepalived --with-init<span class="token operator">=</span>SYSV
<span class="token comment">#注：(upstart|systemd|SYSV|SUSE|openrc) #根据你的系统选择对应的启动方式</span>
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="配置keepalived" tabindex="-1"><a class="header-anchor" href="#配置keepalived" aria-hidden="true">#</a> 配置KeepAlived</h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">cp</span> /opt/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/
<span class="token function">cp</span> /opt/keepalived/etc/sysconfig/keepalived /etc/sysconfig
<span class="token function">cp</span> /opt/keepalived/sbin/keepalived /usr/sbin/
<span class="token function">chmod</span> +x /etc/init.d/keepalived
<span class="token function">chkconfig</span> <span class="token parameter variable">--add</span> keepalived
<span class="token function">chkconfig</span> keepalived on
<span class="token comment">#Keepalived默认会读取/etc/keepalived/keepalived.conf配置文件</span>
<span class="token function">mkdir</span> /etc/keepalived
<span class="token function">cp</span> /opt/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来修改/etc/keepalived/keepalived.conf文件，在Keepalived的Master上配置详情如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>! Configuration File for keepalived
#Keepalived配置文件
global_defs {
        router_id NodeA                 #路由ID, 主备的ID不能相同
}
#自定义监控脚本
vrrp_script chk_haproxy {
        script &quot;/etc/keepalived/check_haproxy.sh&quot;
        interval 5
        weight 2
}
vrrp_instance VI_1 {
        state MASTER #Keepalived的角色。Master表示主服务器，从服务器设置为BACKUP
        interface eth0          #指定监测网卡
        virtual_router_id 1
        priority 100            #优先级，BACKUP机器上的优先级要小于这个值
        advert_int 1            #设置主备之间的检查时间，单位为s
        authentication {        #定义验证类型和密码
                auth_type PASS
                auth_pass root123
        }
        track_script {
                chk_haproxy
        }
        virtual_ipaddress {     #VIP地址，可以设置多个：
                1.117.149.141
        }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">service</span> keepalived start
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="federation-exchange-联邦交换机" tabindex="-1"><a class="header-anchor" href="#federation-exchange-联邦交换机" aria-hidden="true">#</a> Federation Exchange(联邦交换机)</h3><h4 id="为什么使用联邦交换机" tabindex="-1"><a class="header-anchor" href="#为什么使用联邦交换机" aria-hidden="true">#</a> 为什么使用联邦交换机</h4><p>(broker 北京)，(broker 深圳)彼此之间相距甚远，网络延迟是一个不得不面对的问题。有一个在北京 的业务(Client 北京) 需要连接(broker 北京)，向其中的交换器 exchangeA 发送消息，此时的网络延迟很小， (Client 北京)可以迅速将消息发送至 exchangeA 中，就算在开启了 publisherconfirm 机制或者事务机制的 情况下，也可以迅速收到确认信息。此时又有个在深圳的业务(Client 深圳)需要向 exchangeA 发送消息， 那么(Client 深圳) (broker 北京)之间有很大的网络延迟，(Client 深圳) 将发送消息至 exchangeA 会经历一 定的延迟，尤其是在开启了 publisherconfirm 机制或者事务机制的情况下，(Client 深圳) 会等待很长的延 迟时间来接收(broker 北京)的确认信息，进而必然造成这条发送线程的性能降低，甚至造成一定程度上的 阻塞。</p><p>将业务(Client 深圳)部署到北京的机房可以解决这个问题，但是如果(Client 深圳)调用的另些服务都部 署在深圳，那么又会引发新的时延问题，总不见得将所有业务全部部署在一个机房，那么容灾又何以实现？ 这里使用 Federation 插件就可以很好地解决这个问题.</p><figure><img src="/assets/58cb2a8cf3f7f167932b95ccfe512b8d-16444444.png" alt="image-20211228104716030" tabindex="0" loading="lazy"><figcaption>image-20211228104716030</figcaption></figure><h4 id="搭建步骤" tabindex="-1"><a class="header-anchor" href="#搭建步骤" aria-hidden="true">#</a> 搭建步骤</h4><h5 id="需要保证每台节点单独运行" tabindex="-1"><a class="header-anchor" href="#需要保证每台节点单独运行" aria-hidden="true">#</a> 需要保证每台节点单独运行</h5><h5 id="在每台机器上开启federation相关插件" tabindex="-1"><a class="header-anchor" href="#在每台机器上开启federation相关插件" aria-hidden="true">#</a> 在每台机器上开启federation相关插件</h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_federation
rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_federation_management
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/assets/ee225dcc049ce6d807ce8b500cbe9c5b-8ae24f7b.png" alt="image-20211228104904358" tabindex="0" loading="lazy"><figcaption>image-20211228104904358</figcaption></figure><h5 id="原理图-先运行consumer在node2创建fed-exchange" tabindex="-1"><a class="header-anchor" href="#原理图-先运行consumer在node2创建fed-exchange" aria-hidden="true">#</a> 原理图(先运行consumer在node2创建fed_exchange)</h5><figure><img src="/assets/03d120941f0fa6e53dbd57bd44c272f7-35f99928.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>消费者代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>

    <span class="token comment">//队列的名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_NAME</span><span class="token operator">=</span><span class="token string">&quot;mirrior_hello&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//交换机的名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">FED_EXCHANGE</span><span class="token operator">=</span><span class="token string">&quot;fed_exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//接收消息</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> factory<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.159.34&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">FED_EXCHANGE</span><span class="token punctuation">,</span><span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;node2_queue&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token string">&quot;node2_queue&quot;</span><span class="token punctuation">,</span><span class="token constant">FED_EXCHANGE</span><span class="token punctuation">,</span><span class="token string">&quot;routeKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//声明 接收消息</span>
        <span class="token class-name">DeliverCallback</span> deliverCallback<span class="token operator">=</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//取消消息时的回调</span>
        <span class="token class-name">CancelCallback</span> cancelCallback<span class="token operator">=</span>consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息消费被中断&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>


        <span class="token doc-comment comment">/**
         * 消费者消费消息
         * 1.消费哪个队列
         * 2.消费成功之后是否要自动应答 true代表自动应答 false手动应答
         * 3.消费者成功消费的回调
         * 4.消费者取消消费的回调
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>deliverCallback<span class="token punctuation">,</span>cancelCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="在downstream-node2-配置upstream-node1" tabindex="-1"><a class="header-anchor" href="#在downstream-node2-配置upstream-node1" aria-hidden="true">#</a> 在downstream(node2)配置upstream(node1)</h5><figure><img src="/assets/116491900ab6367250e8c40175785643-49753c49.png" alt="image-20211228105308071" tabindex="0" loading="lazy"><figcaption>image-20211228105308071</figcaption></figure><h5 id="添加policy" tabindex="-1"><a class="header-anchor" href="#添加policy" aria-hidden="true">#</a> 添加policy</h5><figure><img src="/assets/22b3723e5b78c16d1aa6a2cc59f025f6-e3c1c527.png" alt="image-20211228105345952" tabindex="0" loading="lazy"><figcaption>image-20211228105345952</figcaption></figure><p>查看下是否搭建成功，点击<strong>Federation Status</strong></p><figure><img src="/assets/bd7852952b76fd75b083947c59c727d7-6dae955e.png" alt="image-20211228105426346" tabindex="0" loading="lazy"><figcaption>image-20211228105426346</figcaption></figure><h5 id="查看下是否搭建成功-点击federation-status" tabindex="-1"><a class="header-anchor" href="#查看下是否搭建成功-点击federation-status" aria-hidden="true">#</a> 查看下是否搭建成功，点击<strong>Federation Status</strong></h5><figure><img src="/assets/bd7852952b76fd75b083947c59c727d7-6dae955e.png" alt="image-20211228105426346" tabindex="0" loading="lazy"><figcaption>image-20211228105426346</figcaption></figure><h3 id="federation-queue-联邦队列" tabindex="-1"><a class="header-anchor" href="#federation-queue-联邦队列" aria-hidden="true">#</a> Federation Queue(联邦队列)</h3><h4 id="为什么使用联邦队列" tabindex="-1"><a class="header-anchor" href="#为什么使用联邦队列" aria-hidden="true">#</a> 为什么使用联邦队列</h4><p>联邦队列可以在多个 Broker 节点(或者集群)之间为单个队列提供均衡负载的功能。一个联邦队列可以 连接一个或者多个上游队列(upstream queue)，并从这些上游队列中获取消息以满足本地消费者消费消息 的需求。</p><h4 id="搭建步骤-1" tabindex="-1"><a class="header-anchor" href="#搭建步骤-1" aria-hidden="true">#</a> 搭建步骤</h4><h5 id="原理图" tabindex="-1"><a class="header-anchor" href="#原理图" aria-hidden="true">#</a> 原理图</h5><figure><img src="/assets/3425e263f92b3fef5e589359f846cf5b-6f5be712.png" alt="image-20211228105514723" tabindex="0" loading="lazy"><figcaption>image-20211228105514723</figcaption></figure><h5 id="添加upstream" tabindex="-1"><a class="header-anchor" href="#添加upstream" aria-hidden="true">#</a> 添加upstream</h5><figure><img src="/assets/116491900ab6367250e8c40175785643-49753c49.png" alt="image-20211228105308071" tabindex="0" loading="lazy"><figcaption>image-20211228105308071</figcaption></figure><h5 id="添加policy-1" tabindex="-1"><a class="header-anchor" href="#添加policy-1" aria-hidden="true">#</a> 添加policy</h5><figure><img src="/assets/24f2a3f7da0a333319475d3d3b0cefb1-c7eaa9b7.png" alt="image-20211228105700743" tabindex="0" loading="lazy"><figcaption>image-20211228105700743</figcaption></figure><h3 id="shovel" tabindex="-1"><a class="header-anchor" href="#shovel" aria-hidden="true">#</a> Shovel</h3><h4 id="为什么使用shovel" tabindex="-1"><a class="header-anchor" href="#为什么使用shovel" aria-hidden="true">#</a> 为什么使用Shovel</h4><p>Federation 具备的数据转发功能类似，Shovel 够可靠、持续地从一个 Broker 中的队列(作为源端，即 source)拉取数据并转发至另一个 Broker 中的交换器(作为目的端，即 destination)。作为源端的队列和作 为目的端的交换器可以同时位于同一个 Broker，也可以位于不同的 Broker 上。Shovel 可以翻译为&quot;铲子&quot;， 是一种比较形象的比喻，这个&quot;铲子&quot;可以将消息从一方&quot;铲子&quot;另一方。Shovel 行为就像优秀的客户端应用 程序能够负责连接源和目的地、负责消息的读写及负责连接失败问题的处理。</p><h4 id="搭建步骤-2" tabindex="-1"><a class="header-anchor" href="#搭建步骤-2" aria-hidden="true">#</a> 搭建步骤</h4><h5 id="开启的插件-需要的机器都开启" tabindex="-1"><a class="header-anchor" href="#开启的插件-需要的机器都开启" aria-hidden="true">#</a> 开启的插件(需要的机器都开启)</h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_shovel
rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_shovel_management
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/assets/488099203454f3a78f12eff069ac3609-2bb61863.png" alt="image-20211228105852548" tabindex="0" loading="lazy"><figcaption>image-20211228105852548</figcaption></figure><figure><img src="/assets/8e3a014be9a7577ca72317bd9c7fc2d7-45b02af7.png" alt="image-20211228105911013" tabindex="0" loading="lazy"><figcaption>image-20211228105911013</figcaption></figure><h5 id="原理图-在源头发送的消息直接会进入到目的地队列" tabindex="-1"><a class="header-anchor" href="#原理图-在源头发送的消息直接会进入到目的地队列" aria-hidden="true">#</a> 原理图(在源头发送的消息直接会进入到目的地队列)</h5><figure><img src="/assets/35a6196faf70c52a5754024fcb6f8f17-006d39c7.png" alt="image-20211228105953134" tabindex="0" loading="lazy"><figcaption>image-20211228105953134</figcaption></figure><h5 id="添加shovel源和目的地" tabindex="-1"><a class="header-anchor" href="#添加shovel源和目的地" aria-hidden="true">#</a> 添加shovel源和目的地</h5><figure><img src="/assets/bfd44cd1493e6b7027f5e13749c0737f-191544f3.png" alt="image-20211228110016947" tabindex="0" loading="lazy"><figcaption>image-20211228110016947</figcaption></figure><p>检查下是否搭建成功</p><figure><img src="/assets/0fb19272898bee8024bbfc5ffe8335c8-af5585ed.png" alt="image-20211228110049591" tabindex="0" loading="lazy"><figcaption>image-20211228110049591</figcaption></figure></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 1020205116@qq.com">白米粥</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/code/Nginx.html" class="nav-link prev" aria-label="Nginx学习笔记"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->Nginx学习笔记</div></a><a href="/code/Shiro.html" class="nav-link next" aria-label="Shiro学习笔记"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">Shiro学习笔记<!----></div></a></nav><div class="giscus-wrapper input-top" id="comment" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">Theme by <a href="https://theme-hope.vuejs.press">vuepress-theme-hope</a></div><!----></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-8bdbcd56.js" defer></script>
  </body>
</html>
